<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROYECTO FELONÍA</title>
    <!-- Favicon: Huella Dactilar Verde -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='none' stroke='%2322c55e' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M2 12C2 6.5 6.5 2 12 2s10 4.5 10 10'/%3E%3Cpath d='M5 15c.5-4 4.5-7 7-7s6.5 3 7 7'/%3E%3Cpath d='M8 18c.5-2.5 2-4.5 4-4.5s3.5 2 4 4.5'/%3E%3Cpath d='M11 21c.5-1 1-1.5 1-1.5s.5.5 1 1.5'/%3E%3Cpath d='M12 12v.01'/%3E%3C/svg%3E">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Ocultar Scrollbar */
        .scrollbar-none::-webkit-scrollbar { display: none; }
        .scrollbar-none { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animaciones */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.3s ease-in-out; }
        
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Cursor parpadeante */
        .cursor-blink::after {
            content: '█';
            animation: blink 1s step-end infinite;
            color: #22c55e;
            margin-left: 2px;
        }
        @keyframes blink { 50% { opacity: 0; } }

        .zoom-in { animation: zoomIn 0.3s ease-out forwards; }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-pulse-soft { animation: pulse-soft 3s infinite; }

        body { 
            background-color: #0c0a09; 
            color: #ecfccb; 
            user-select: none; 
            -webkit-user-select: none;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .level-card {
            width: 280px;
            height: 280px;
            flex-shrink: 0;
            position: relative;
            z-index: 10;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .level-card:hover {
            z-index: 50;
            transform: scale(1.05);
            box-shadow: 0 0 40px rgba(34, 197, 94, 0.15);
        }

        .modal-content-area {
            height: 440px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #system-notification-container {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1500;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            width: 100%;
            max-width: 500px;
        }

        .system-notification {
            background-color: rgba(12, 10, 9, 0.95);
            border: 1px solid #166534;
            color: #ecfccb;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: slideDownIn 0.4s ease-out forwards;
            pointer-events: auto;
            width: 90%;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        @keyframes slideDownIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .notification-exit {
            animation: slideUpOut 0.4s ease-in forwards;
        }

        @keyframes slideUpOut {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(-20px); opacity: 0; }
        }

        /* Dial / Slider Personalizado */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 12px;
            cursor: pointer;
            background: #1c1917;
            border-radius: 6px;
            border: 1px solid #166534;
        }
        input[type=range]::-webkit-slider-thumb {
            height: 30px;
            width: 30px;
            border-radius: 50%;
            background: #22c55e;
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -10px;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.5);
        }

        #story-screen { z-index: 500; }
        #main-layout { display: flex; flex-direction: column; height: 100%; width: 100%; }

        /* Lights Out */
        .light-btn { transition: all 0.3s ease; }
        .light-on { background-color: #22c55e; box-shadow: 0 0 15px rgba(34, 197, 94, 0.6); }
        .light-off { background-color: #1c1917; border: 1px solid #292524; }

        /* Estilos para las cartas de Memoria (Nivel 3) */
        .memory-card {
            perspective: 1000px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .memory-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.4s;
            transform-style: preserve-3d;
        }
        .memory-card.flipped .memory-card-inner {
            transform: rotateY(180deg);
        }
        .memory-card-front, .memory-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            border: 1px solid rgba(22, 101, 52, 0.5);
        }
        .memory-card-front {
            background-color: #1c1917; /* Stone 900 */
        }
        .memory-card-back {
            background-color: #22c55e; /* Green 500 para acierto, o fondo del icono */
            background: radial-gradient(circle, #064e3b 0%, #022c22 100%);
            color: #4ade80;
            transform: rotateY(180deg);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
        }
        /* Carta Matcheada */
        .memory-card.matched .memory-card-back {
            border-color: #4ade80;
            box-shadow: 0 0 20px #22c55e;
        }
    </style>
</head>
<body class="font-sans selection:bg-green-700/30" oncontextmenu="return false" ondragstart="return false">

    <div id="system-notification-container"></div>

    <!-- INTRO SEQUENCE -->
    <div id="intro-screen" class="fixed inset-0 z-[1000] bg-black flex flex-col items-center justify-center p-8 font-mono text-green-500">
        <div class="max-w-xl w-full space-y-4">
            <div id="terminal-output" class="text-sm md:text-base leading-relaxed opacity-90 min-h-[200px]"></div>
            <div id="loading-container" class="hidden mt-8 w-full">
                <div class="text-xs mb-2 text-green-400 font-bold uppercase tracking-widest text-center">Iniciando Sistema...</div>
                <div class="w-full bg-stone-900 h-2 border border-green-900/50 rounded-full overflow-hidden">
                    <div id="intro-progress-bar" class="bg-green-600 h-full w-0 shadow-[0_0_15px_rgba(22,163,74,0.4)]"></div>
                </div>
                <div id="intro-percentage" class="text-right text-xs text-green-600 mt-2 font-mono">0%</div>
            </div>
        </div>
    </div>

    <!-- Background Layer -->
    <div id="bg-effects" class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_#1c1917_0%,_#0c0a09_100%)]"></div>
        <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-green-900/10 blur-[150px] rounded-full animate-pulse-soft"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-emerald-900/10 blur-[150px] rounded-full animate-pulse-soft" style="animation-delay: 1s;"></div>
    </div>

    <!-- PANTALLA DE HISTORIA -->
    <div id="story-screen" class="hidden fixed inset-0 bg-stone-950 p-6 md:p-12 flex flex-col items-center justify-start font-serif text-center overflow-y-auto scrollbar-none">
        <div class="max-w-5xl w-full relative z-10 pt-10 px-4">
            <button onclick="closeStory()" class="absolute top-0 right-0 text-stone-500 hover:text-green-400 transition-colors z-[600] p-4">
                <i data-lucide="x" class="w-12 h-12"></i>
            </button>
            <h1 class="text-3xl md:text-5xl text-green-100 uppercase tracking-[0.3em] font-light border-b border-green-900/50 pb-8 mb-12">Archivo: Nuestra Historia</h1>
            <div id="story-content" class="space-y-12 text-xl md:text-2xl text-stone-300 leading-relaxed text-left min-h-[300px] font-mono"></div>
            <div class="mt-24 pt-12 border-t border-green-900/30 text-left font-mono opacity-60">
                <p class="text-xs text-green-700 uppercase mb-3 font-bold tracking-widest">ID_SESIÓN: <span id="display-user-id" class="text-green-500 select-all font-bold tracking-widest uppercase">Cargando ID...</span></p>
                <button onclick="restoreSessionPrompt()" class="text-xs px-6 py-3 bg-green-900/10 border border-green-700/30 text-green-400 hover:bg-green-900/30 rounded transition-all uppercase font-bold tracking-widest">Restaurar Avance</button>
            </div>
        </div>
    </div>

    <div id="main-layout" class="relative z-10">
        <header id="main-header" class="w-full pl-6 pr-10 py-8 flex justify-between items-center z-[100] opacity-0 transition-opacity duration-1000">
            <button onclick="showStory()" class="flex items-center gap-6 group cursor-pointer hover:opacity-80 transition-opacity text-left">
                <div class="p-3 bg-green-900/10 rounded-xl group-hover:bg-green-900/20 border border-green-900/20 transition-all shadow-[0_0_20px_rgba(22,163,74,0.15)]">
                    <i data-lucide="fingerprint" class="text-green-600 w-10 h-10"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-light tracking-[0.4em] text-green-100 uppercase leading-none">Proyecto Felonía</h1>
                    <p class="text-[10px] text-stone-500 uppercase tracking-[0.3em] group-hover:text-green-400 transition-colors font-bold mt-2">Núcleo Operativo: Activo</p>
                </div>
            </button>
        </header>

        <main id="main-content" class="flex-1 w-full px-6 py-6 overflow-y-auto scrollbar-none opacity-0 transition-opacity duration-1000">
            <div id="level-grid" class="w-full flex flex-wrap justify-center gap-8 md:gap-12"></div>
        </main>
    </div>

    <!-- MODAL -->
    <div id="modal-overlay" class="hidden fixed inset-0 z-[800] bg-stone-950/90 backdrop-blur-md flex items-center justify-center p-6">
        <div class="w-full max-w-5xl bg-stone-900/95 border border-green-800/30 rounded-3xl shadow-[0_0_100px_rgba(0,0,0,1)] flex flex-col md:flex-row min-h-[600px] zoom-in relative overflow-hidden">
            <div class="w-full md:w-1/3 bg-stone-950 p-10 border-b md:border-b-0 md:border-r border-green-900/20 flex flex-col justify-between relative">
                <div class="absolute top-0 left-0 w-full h-1.5 bg-stone-900">
                    <div id="time-bar" class="h-full bg-gradient-to-r from-green-800 to-green-600 transition-all duration-1000 ease-linear"></div>
                </div>
                <div>
                    <div class="text-xs text-green-600 font-mono mb-4 flex items-center gap-3 tracking-[0.2em] uppercase font-bold">
                        <i data-lucide="activity" class="w-4 h-4 animate-pulse"></i>
                        <span id="timer-label">Analizando...</span>
                    </div>
                    <div id="timer-display" class="text-7xl font-extralight text-white font-mono tracking-tighter">--:--</div>
                </div>
                <div class="space-y-6">
                    <h2 id="modal-title" class="text-2xl text-green-100 uppercase tracking-widest font-light">Bloqueado</h2>
                    <p id="modal-desc" class="text-sm text-stone-400 leading-relaxed font-light text-justify border-l border-green-900/30 pl-4"></p>
                </div>
                <div class="text-xs text-stone-600 font-mono mt-auto uppercase tracking-widest opacity-50" id="modal-id-display">ID: 01 // SEC_HEX</div>
            </div>
            
            <div class="w-full md:w-2/3 p-10 flex items-center justify-center bg-stone-900/30 relative overflow-hidden">
                <div id="modal-content" class="w-full modal-content-area space-y-8"></div>
            </div>
        </div>
    </div>

    <script>
        const RELATIONSHIP_DATA = [
            { 
                id: 1, 
                title: "El Encuentro", 
                storyFragment: `Fue en mi cumpleaños, el 21 de marzo de 2025. Tú asististe a esa actividad que me organizaron, y aunque tu decisión oficial era llevarme al metro, terminaste conduciendo hacia mi casa. Sin embargo, el destino tenía otros planes y nos detuvimos antes, en una esquina oscura bajo el manto de la noche.<br><br>Allí, la tensión sexual que habíamos estado cocinando a fuego lento durante todo el camino —alimentada por aquel contrato de sumisión que firmamos días atrás— finalmente detonó. No hubo palabras, solo acción. Nos empezamos a besar con urgencia, a tocarnos, a chuparnos... Los minutos se diluyeron en un caos de deseo absoluto donde nada más importaba.<br><br>Todo escaló peligrosamente rápido, una espiral de pasión que amenazaba con consumirnos ahí mismo, hasta que la realidad nos obligó a parar. Tuvimos que irnos, cada uno a su destino, pero marcados por la certeza de que algo irreversible había comenzado en esa esquina.`, 
                question: "Equinoccio de Primavera del año de la Singularidad (DDMMAAAA).", 
                answer: "21032025", 
                type: "chaospad", 
                game: "tictactoe_impossible", 
                timeLimit: 1260, // 21 minutos
                icon: "car-front" 
            },
            { 
                id: 2, 
                title: "Pacto de Sangre", 
                storyFragment: `Después de aquella esquina, el trabajo se convirtió en un campo de minas emocional. Siete días de resistencia absoluta. Trabajábamos hombro con hombro, intercambiando besos furtivos en la cocina fría de nuestro local mientras el mundo seguía girando. Los trayectos en tu vehículo, las miradas profundas que lo decían todo y esos abrazos que intentaban contener lo incontenible.<br><br>Planificamos el escape hacia aquel Airbnb con la precisión de quien sabe que está a punto de detonar. El 28 de marzo llegó y, tras salir del colegio, pusimos rumbo a nuestro destino. Un contratiempo biológico —tu periodo— apareció en escena, pero la espera había sido demasiado larga como para retroceder. Tras discutirlo, la decisión fue unánime: continuar.<br><br>La atmósfera se cargó tras la ducha. Los besos iniciales dieron paso a una entrega total que comenzó con la intimidad de tus labios recorriéndome, escalando hasta que te tomé en brazos y te hice mía. La emoción me desbordó repetidas veces, pero el deseo nos mantuvo habitando diferentes rincones de la casa, una y otra vez, hasta que el tiempo nos obligó a separarnos. Aquella noche, las coordenadas de nuestra historia quedaron grabadas para siempre.`, 
                question: "¿Cuántos días transcurrieron desde la tensión de la esquina hasta la consumación final?", 
                answer: "7", 
                type: "dial", 
                game: "lights_out", 
                timeLimit: 1260, // 21 minutos
                icon: "droplet" 
            },
            { 
                id: 3, 
                title: "Cómplices", 
                storyFragment: `La intimidad a medias del primer encuentro nos dejó un hambre voraz. Buscamos la revancha y la encontramos en aquella actividad con colegas, en el Airbnb. Mientras estábamos rodeados de todos, bajo las sábanas, el roce prohibido de nuestras manos encendía la mecha mientras fingíamos normalidad.<br><br>Al caer la noche y silenciarse la casa, el riesgo se convirtió en nuestra invitación. Me colé en tu habitación bajo el manto de la madrugada del 16 de abril. Esta vez, tomaste el control absoluto. No hubo pasividad; me usaste, me recorriste y me poseíste. En la cama, de pie, en el suelo... cada rincón fue testigo de nuestro deseo contenido.<br><br>Fueron horas de frenesí donde tú llevabas las riendas, una exploración activa y hambrienta que solo se detuvo cuando el sonido de la realidad —una colega despertando— amenazó nuestra burbuja. Tuve que huir de tu habitación, con el cuerpo saciado pero el alma pidiendo más.`, 
                question: "CÁLCULO TEMPORAL: Días transcurridos entre el 'Pacto de Sangre' y la Infiltración Nocturna en el Airbnb. Sincroniza la matriz.", 
                answer: "19", 
                type: "sum_matrix", 
                game: "memory_match", 
                timeLimit: 1260, // 21 minutos
                icon: "bed-double" 
            },
            { id: 4, title: "DATA ENCRIPTADA", storyFragment: "...", question: "TBD", answer: "TBD", type: "TBD", game: "TBD", timeLimit: 1260, icon: "lock" },
            { id: 5, title: "DATA ENCRIPTADA", storyFragment: "...", question: "TBD", answer: "TBD", type: "TBD", game: "TBD", timeLimit: 1260, icon: "lock" },
            { id: 6, title: "DATA ENCRIPTADA", storyFragment: "...", question: "TBD", answer: "TBD", type: "TBD", game: "TBD", timeLimit: 1260, icon: "lock" },
            { id: 7, title: "DATA ENCRIPTADA", storyFragment: "...", question: "TBD", answer: "TBD", type: "TBD", game: "TBD", timeLimit: 1260, icon: "lock" },
            { id: 8, title: "DATA ENCRIPTADA", storyFragment: "...", question: "TBD", answer: "TBD", type: "TBD", game: "TBD", timeLimit: 1260, icon: "lock" },
            { id: 9, title: "DATA ENCRIPTADA", storyFragment: "...", question: "TBD", answer: "TBD", type: "TBD", game: "TBD", timeLimit: 1260, icon: "lock" },
            { id: 10, title: "DATA ENCRIPTADA", storyFragment: "...", question: "TBD", answer: "TBD", type: "TBD", game: "TBD", timeLimit: 1260, icon: "lock" }
        ];

        let userId = "", completedLevels = [], levelTimestamps = {}, tttAttempts = 0;
        let activeLevelData = null, timeLeft = 0, graceTime = 0, isGracePeriod = false, timerInterval = null, modalStage = "game", gameInternalState = {};

        function showSystemMessage(message, type = 'info') {
            const container = document.getElementById('system-notification-container');
            const notification = document.createElement('div');
            notification.className = 'system-notification';
            let icon = type === 'error' ? 'alert-octagon' : (type === 'success' ? 'check-circle' : 'info');
            notification.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 ${type === 'error' ? 'text-red-500' : (type === 'success' ? 'text-green-400' : 'text-blue-400')}"></i><div class="flex-1 text-sm leading-snug font-mono">${message}</div>`;
            container.appendChild(notification); lucide.createIcons();
            setTimeout(() => { notification.classList.add('notification-exit'); notification.addEventListener('animationend', () => notification.remove()); }, 4000);
        }

        window.onload = () => { 
            initSession(); 
            runIntroSequence(); 
            lucide.createIcons();
            setInterval(renderGrid, 60000);
        };

        function initSession() {
            userId = localStorage.getItem('maria_user_id') || ('FEL-' + Math.random().toString(36).substr(2, 9).toUpperCase());
            localStorage.setItem('maria_user_id', userId);
            const displayId = document.getElementById('display-user-id');
            if(displayId) displayId.innerText = userId;
            loadProgressLocal(); renderGrid();
        }

        function loadProgressLocal() {
            completedLevels = JSON.parse(localStorage.getItem('maria_completed') || '[]');
            levelTimestamps = JSON.parse(localStorage.getItem('maria_level_timestamps') || '{}');
            tttAttempts = parseInt(localStorage.getItem('maria_ttt_attempts') || '0');
        }

        function saveToLocal(shouldSync = true) {
            localStorage.setItem('maria_completed', JSON.stringify(completedLevels));
            localStorage.setItem('maria_level_timestamps', JSON.stringify(levelTimestamps));
            localStorage.setItem('maria_ttt_attempts', tttAttempts.toString());
        }

        function restoreSessionPrompt() {
            const old = prompt("INGRESE ID_SESIÓN PARA RESTAURAR:");
            if (old && old.startsWith('FEL-')) { localStorage.setItem('maria_user_id', old.trim()); location.reload(); }
        }

        async function runIntroSequence() {
            const out = document.getElementById('terminal-output'), loader = document.getElementById('loading-container');
            const lines = ["ENLACE: DIDAC-CLICK GROUP SECURE SERVER", "ESTABLECIENDO CONEXIÓN SEGURA...", "ACCEDIENDO AL NÚCLEO DE MEMORIA...", "INICIANDO PROTOCOLO: PROYECTO FELONÍA v1.0", "ESTADO: ESPERANDO USUARIO."];
            if (completedLevels.length > 0) { skipIntro(); return; }
            for (let line of lines) {
                const p = document.createElement('div'); p.className = "mb-4 text-green-500 font-mono text-lg"; p.innerHTML = "> "; out.appendChild(p);
                for (let i = 0; i < line.length; i++) {
                    p.innerHTML = "> " + line.substring(0, i+1) + "<span class='cursor-blink'></span>";
                    await new Promise(r => setTimeout(r, 45));
                }
                p.innerHTML = "> " + line; await new Promise(r => setTimeout(r, 400));
            }
            loader.classList.remove('hidden');
            const bar = document.getElementById('intro-progress-bar'), pct = document.getElementById('intro-percentage');
            for (let i = 0; i <= 100; i++) { bar.style.width = i + "%"; pct.innerText = i + "%"; await new Promise(r => setTimeout(r, 110)); }
            endIntro();
        }

        function skipIntro() {
            const intro = document.getElementById('intro-screen'); if(intro) intro.classList.add('hidden');
            document.getElementById('main-header').classList.replace('opacity-0', 'opacity-100');
            document.getElementById('main-content').classList.replace('opacity-0', 'opacity-100');
        }

        function endIntro() {
            const scr = document.getElementById('intro-screen'); if(!scr) return;
            scr.style.transition = "opacity 1s"; scr.style.opacity = "0";
            setTimeout(() => { scr.classList.add('hidden'); skipIntro(); }, 1000);
        }

        function renderGrid() {
            const grid = document.getElementById('level-grid'); if(!grid) return;
            grid.innerHTML = ''; 
            
            // Obtener el tiempo actual y crear un objeto Date
            const nowObj = new Date();
            const now = nowObj.getTime();
            
            RELATIONSHIP_DATA.forEach(lvl => {
                const done = completedLevels.includes(lvl.id);
                let locked = true;
                let timeText = "BLOQUEADO";

                // LÓGICA DE DESBLOQUEO ACTUALIZADA
                if (lvl.id === 1) { 
                    // Nivel 1 siempre desbloqueado
                    locked = false; 
                    timeText = "INICIAR";
                } else {
                    const prevLevelId = lvl.id - 1;
                    if (completedLevels.includes(prevLevelId)) {
                        // Obtener fecha de completado del nivel anterior
                        const prevTimestamp = levelTimestamps[prevLevelId] || 0;
                        const prevDate = new Date(prevTimestamp);
                        
                        // CALCULAR EL DÍA SIGUIENTE (00:00:00)
                        // Crear una nueva fecha basada en la fecha de completado
                        const unlockDate = new Date(prevDate);
                        // Sumar un día
                        unlockDate.setDate(unlockDate.getDate() + 1);
                        // Resetear hora a medianoche (00:00:00.000)
                        unlockDate.setHours(0, 0, 0, 0);
                        
                        // Comparar si el momento actual ya pasó la fecha de desbloqueo
                        if (nowObj >= unlockDate) {
                            locked = false;
                            timeText = "ACCESO DIARIO";
                        } else {
                            locked = true;
                            // Calcular tiempo restante hasta unlockDate
                            const diff = unlockDate.getTime() - now;
                            const hours = Math.floor(diff / 3600000);
                            const minutes = Math.floor((diff % 3600000) / 60000);
                            timeText = `DISPONIBLE EN: ${hours}h ${minutes}m`;
                        }
                    } else {
                        // Nivel anterior no completado
                        locked = true;
                        timeText = "REQUIERE NIVEL " + prevLevelId;
                    }
                }

                const btn = document.createElement('button');
                const displayTitle = locked ? "SECTOR ENCRIPTADO" : lvl.title;
                const displayIcon = locked ? "lock" : lvl.icon;

                btn.className = `level-card rounded-[3rem] p-10 flex flex-col justify-between text-left group overflow-hidden ${locked ? 'bg-stone-900/30 border border-stone-800 opacity-50 cursor-not-allowed' : (done ? 'bg-green-900/10 border border-green-800/30' : 'bg-gradient-to-br from-stone-900 to-stone-950 border border-green-700/50 cursor-pointer')}`;
                if (!locked) btn.onclick = () => done ? showSystemMessage("REGISTRO YA RECUPERADO.", "info") : openLevel(lvl);
                btn.innerHTML = `<div class="flex justify-between items-start z-10"><span class="text-base font-mono ${locked ? 'text-stone-600' : 'text-green-500'} font-bold uppercase tracking-[0.2em]">0${lvl.id}</span><i data-lucide="${done ? 'star' : (locked ? 'lock' : 'unlock')}" class="w-7 h-7 ${done ? 'text-green-500 fill-green-500' : (locked ? 'text-stone-700' : 'text-green-500 animate-pulse')}"></i></div><div class="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none"><i data-lucide="${displayIcon}" width="120"></i></div><div class="z-10 mt-6"><h3 class="text-2xl font-light tracking-wide ${done ? 'text-green-700/50 line-through' : 'text-green-100'}">${displayTitle}</h3><span class="text-[10px] uppercase tracking-[0.3em] text-green-600 font-bold mt-4 block">${locked ? timeText : (done ? 'Fragmento Recuperado' : 'Acceso Autorizado')}</span></div>`;
                grid.appendChild(btn);
            });
            lucide.createIcons();
        }

        function openLevel(data) {
            activeLevelData = data; timeLeft = data.timeLimit; graceTime = 15; isGracePeriod = true; modalStage = "game";
            document.getElementById('modal-overlay').classList.remove('hidden');
            updateModalUI(); startLevelTimer();
        }

        function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); if (timerInterval) clearInterval(timerInterval); activeLevelData = null; if(gameInternalState.animFrame) cancelAnimationFrame(gameInternalState.animFrame); if(gameInternalState.timeouts) gameInternalState.timeouts.forEach(clearTimeout); }

        function startLevelTimer() {
            if (timerInterval) clearInterval(timerInterval); updateTimerDisplay();
            timerInterval = setInterval(() => {
                if (isGracePeriod) { if (--graceTime <= 0) isGracePeriod = false; }
                else { // Se quitó la restricción de ID 1
                    if (--timeLeft <= 0) { 
                        clearInterval(timerInterval); 
                        closeModal(); 
                        showSystemMessage("TIEMPO AGOTADO. REINTENTA.", "error"); 
                    } 
                }
                updateTimerDisplay();
            }, 1000);
        }

        function updateTimerDisplay() {
            const lbl = document.getElementById('timer-label'), disp = document.getElementById('timer-display'), bar = document.getElementById('time-bar');
            if (isGracePeriod) { 
                lbl.innerText = "Protocolo de Lectura"; 
                disp.innerText = graceTime + "s"; 
                bar.style.width = "100%"; 
                bar.className = "h-full bg-stone-700"; 
            } else { 
                // Se actualizaron las etiquetas para ser genéricas
                lbl.innerText = "Restante"; 
                disp.innerText = `${Math.floor(timeLeft/60)}:${(timeLeft%60).toString().padStart(2,'0')}`; 
                bar.style.width = (timeLeft/activeLevelData.timeLimit)*100 + "%"; 
                bar.className = "h-full bg-green-600"; 
            }
        }

        function updateModalUI() {
            const title = document.getElementById('modal-title'), desc = document.getElementById('modal-desc'), content = document.getElementById('modal-content');
            content.innerHTML = '';
            
            // Limpiar estados anteriores
            if(gameInternalState.animFrame) cancelAnimationFrame(gameInternalState.animFrame);
            if(gameInternalState.timeouts) gameInternalState.timeouts.forEach(clearTimeout);

            if (modalStage === "game") {
                title.innerText = "Sistema de Defensa";
                if(activeLevelData.game === 'tictactoe_impossible') {
                    desc.innerHTML = `GUARDIÁN: <strong class="text-green-400">KAIROS</strong><br><br>Supera el algoritmo de bloqueo para acceder a la clave del sector.`;
                    renderTTT(content);
                } else if (activeLevelData.game === 'lights_out') {
                    desc.innerHTML = `GUARDIÁN: <strong class="text-green-400">MATRIZ ESCARLATA</strong><br><br>Apaga todos los nodos de tensión para estabilizar el núcleo.`;
                    renderLightsOut(content);
                } else if (activeLevelData.game === 'memory_match') {
                    // DESCRIPCIÓN ACTUALIZADA NIVEL 3
                    desc.innerHTML = `GUARDIÁN: <strong class="text-green-400">MNEMOSYNE</strong><br><br>Empareja los fragmentos de memoria dispersos. <strong class="text-red-500">ADVERTENCIA:</strong> La calavera corrupta reiniciará el sistema.`;
                    renderMemoryMatch(content);
                }
            } else { 
                title.innerText = "Nivel de Seguridad 2"; 
                desc.innerText = activeLevelData.question; 
                if(activeLevelData.type === 'dial') renderDial(content);
                else if (activeLevelData.type === 'sum_matrix') renderSumMatrix(content);
                else renderPad(content);
            }
            lucide.createIcons();
        }

        // --- NIVEL 1: TIC TAC TOE ---
        function renderTTT(container) {
            tttAttempts++; localStorage.setItem('maria_ttt_attempts', tttAttempts);
            gameInternalState.board = Array(9).fill(null); gameInternalState.turn = true; gameInternalState.active = true;
            let html = '<div class="grid grid-cols-3 gap-5 mb-8">';
            for(let i=0; i<9; i++) html += `<button onclick="handleTTT(${i})" id="ttt-${i}" class="w-24 h-24 rounded-3xl bg-stone-800/50 border border-stone-700 text-5xl font-bold text-stone-500 transition-all"></button>`;
            html += `</div><div class="flex flex-col items-center gap-4">`;
            html += `<div class="text-xs font-mono text-stone-500 uppercase tracking-widest text-center">Intento #${tttAttempts}</div></div>`;
            container.innerHTML = html;
        }
        function handleTTT(idx) { if (!gameInternalState.active || gameInternalState.board[idx] || !gameInternalState.turn) return; gameInternalState.board[idx] = 'X'; updateTTTBoard(); if (checkWinTTT('X')) return finishTTT('V'); if (!gameInternalState.board.includes(null)) return finishTTT('E'); gameInternalState.turn = false; setTimeout(aiMove, 600); }
        function aiMove() {
            if (!gameInternalState.active) return; const move = minimaxTTT(gameInternalState.board, 'O').index;
            gameInternalState.board[move] = 'O'; updateTTTBoard(); if (checkWinTTT('O')) return finishTTT('F'); if (!gameInternalState.board.includes(null)) return finishTTT('E'); gameInternalState.turn = true;
        }
        function finishTTT(type) { gameInternalState.active = false; if (type === 'V') { modalStage = "question"; updateModalUI(); } else { showSystemMessage(type === 'F' ? "KAIROS GANÓ. REINICIANDO..." : "EMPATE. REINTENTA.", "info"); setTimeout(() => renderTTT(document.getElementById('modal-content')), 1000); } }
        function updateTTTBoard() { gameInternalState.board.forEach((v,i) => { const b = document.getElementById(`ttt-${i}`); if(b) { b.innerText = v || ''; if(v === 'X') b.className = "w-24 h-24 rounded-3xl bg-green-900/20 border border-green-600 text-5xl font-bold text-green-400"; if(v === 'O') b.className = "w-24 h-24 rounded-3xl bg-stone-800 border border-stone-600 text-5xl font-bold text-white"; } }); }
        function checkWinTTT(p) { const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]]; return wins.some(l => l.every(i => gameInternalState.board[i] === p)); }
        function minimaxTTT(board, p) {
            const avail = board.map((v,i) => v===null?i:null).filter(v=>v!==null); if (checkWinTTT('X')) return {score:-10}; if (checkWinTTT('O')) return {score:10}; if (avail.length === 0) return {score:0};
            const moves = []; for (let i=0; i<avail.length; i++) { const m = {index: avail[i]}; board[avail[i]] = p; m.score = minimaxTTT(board, p==='O'?'X':'O').score; board[avail[i]] = null; moves.push(m); }
            return moves.reduce((a, b) => (p==='O' ? (b.score > a.score) : (b.score < a.score)) ? b : a);
        }

        // --- NIVEL 2: LIGHTS OUT ---
        function renderLightsOut(container) {
            const size = 5; gameInternalState.active = true; gameInternalState.lights = Array(size * size).fill(false);
            for(let i=0; i<15; i++) toggleMechanism(Math.floor(Math.random()*25), 5);
            let html = '<div class="grid grid-cols-5 gap-3 mb-8">';
            for(let i=0; i<25; i++) html += `<button onclick="handleLightClick(${i})" id="light-${i}" class="w-14 h-14 rounded-xl border light-btn ${gameInternalState.lights[i] ? 'light-on' : 'light-off'}"></button>`;
            html += '</div>';
            container.innerHTML = html;
        }
        function handleLightClick(idx) { if (!gameInternalState.active) return; toggleMechanism(idx, 5); updateLightsUI(); if (gameInternalState.lights.every(l => !l)) { gameInternalState.active = false; showSystemMessage("DEFENSA DESACTIVADA.", "success"); modalStage = "question"; setTimeout(updateModalUI, 1000); } }
        function toggleMechanism(idx, size) { const r = Math.floor(idx/size), c = idx%size; const ts = [[r,c],[r-1,c],[r+1,c],[r,c-1],[r,c+1]]; ts.forEach(([ro, co]) => { if (ro>=0 && ro<size && co>=0 && co<size) gameInternalState.lights[ro*size+co] = !gameInternalState.lights[ro*size+co]; }); }
        function updateLightsUI() { gameInternalState.lights.forEach((isOn, i) => { const b = document.getElementById(`light-${i}`); if(b) b.className = `w-14 h-14 rounded-xl border light-btn ${isOn ? 'light-on' : 'light-off'}`; }); }

        // --- NIVEL 3: MEMORY MATCH (NUEVO) ---
        function renderMemoryMatch(container) {
            // Iconos solicitados: Pizza, Vino, Amigos (users), Piscina (waves), Camas (bed-double)
            const iconSet = ['pizza', 'wine', 'users', 'waves', 'bed-double'];
            // 2 calaveras trampas
            const traps = ['skull', 'skull'];
            
            // Crear mazo: pares de iconos + trampas
            let deck = [...iconSet, ...iconSet, ...traps];
            // Barajar
            deck.sort(() => Math.random() - 0.5);

            gameInternalState = {
                deck: deck,
                flipped: [], // Indices de cartas volteadas actualmente
                matched: [], // Indices de cartas ya emparejadas
                locked: false, // Bloqueo mientras se verifican pares
                active: true,
                timeouts: []
            };

            let gridHtml = '<div class="grid grid-cols-4 gap-4 mb-4">';
            deck.forEach((iconName, idx) => {
                gridHtml += `
                    <div class="memory-card w-16 h-16 md:w-20 md:h-20" onclick="handleMatchClick(${idx})" id="card-${idx}">
                        <div class="memory-card-inner">
                            <div class="memory-card-front text-stone-600 font-bold text-xl font-mono">?</div>
                            <div class="memory-card-back ${iconName === 'skull' ? 'bg-red-900/50 border-red-500 text-red-500' : ''}">
                                <i data-lucide="${iconName}" class="w-8 h-8"></i>
                            </div>
                        </div>
                    </div>
                `;
            });
            gridHtml += '</div>';
            
            container.innerHTML = `
                <div class="flex flex-col items-center">
                    ${gridHtml}
                    <div class="text-xs font-mono text-stone-500 uppercase tracking-widest text-center mt-4">
                        <span id="match-status">ENCUENTRA LOS PARES</span>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function handleMatchClick(idx) {
            if (!gameInternalState.active || gameInternalState.locked) return;
            if (gameInternalState.flipped.includes(idx) || gameInternalState.matched.includes(idx)) return;

            // Voltear carta visualmente
            const card = document.getElementById(`card-${idx}`);
            card.classList.add('flipped');
            gameInternalState.flipped.push(idx);

            const iconName = gameInternalState.deck[idx];

            // 1. Verificar si es TRAMPA (Calavera)
            if (iconName === 'skull') {
                gameInternalState.locked = true;
                showSystemMessage("AMENAZA DETECTADA: CALAVERA", "error");
                
                // Efecto de sacudida en toda la pantalla
                document.body.classList.add('animate-shake');
                const status = document.getElementById('match-status');
                if(status) {
                    status.innerText = "¡ERROR CRÍTICO! REINICIANDO...";
                    status.className = "text-xs font-mono text-red-500 font-bold uppercase tracking-widest animate-pulse";
                }

                setTimeout(() => {
                    document.body.classList.remove('animate-shake');
                    // Reiniciar el juego
                    renderMemoryMatch(document.getElementById('modal-content'));
                }, 1200);
                return;
            }

            // 2. Verificar par si hay 2 cartas volteadas
            if (gameInternalState.flipped.length === 2) {
                gameInternalState.locked = true;
                const idx1 = gameInternalState.flipped[0];
                const idx2 = gameInternalState.flipped[1];
                const icon1 = gameInternalState.deck[idx1];
                const icon2 = gameInternalState.deck[idx2];

                if (icon1 === icon2) {
                    // COINCIDENCIA
                    gameInternalState.matched.push(idx1, idx2);
                    gameInternalState.flipped = [];
                    gameInternalState.locked = false;
                    
                    document.getElementById(`card-${idx1}`).classList.add('matched');
                    document.getElementById(`card-${idx2}`).classList.add('matched');

                    // Verificar victoria (10 cartas matched, excluyendo las 2 calaveras)
                    if (gameInternalState.matched.length === 10) {
                         gameInternalState.active = false;
                         showSystemMessage("ENLACE NEURAL ESTABLECIDO.", "success");
                         setTimeout(() => { modalStage = "question"; updateModalUI(); }, 1000);
                    }
                } else {
                    // NO COINCIDENCIA
                    setTimeout(() => {
                        document.getElementById(`card-${idx1}`).classList.remove('flipped');
                        document.getElementById(`card-${idx2}`).classList.remove('flipped');
                        gameInternalState.flipped = [];
                        gameInternalState.locked = false;
                    }, 1000);
                }
            }
        }

        // --- PREGUNTA: SUM MATRIX ---
        function renderSumMatrix(container) {
            gameInternalState = {
                currentSum: 0,
                selectedValues: []
            };
            
            // Opciones para sumar 19: e.g. 10 + 5 + 2 + 2
            const options = [10, 5, 8, 4, 3, 2, 2, 1, 7, 6, 12, 9];
            // Shuffle
            options.sort(() => Math.random() - 0.5);
            
            let gridHtml = '<div class="grid grid-cols-4 gap-4 mb-8">';
            options.forEach((val, idx) => {
                gridHtml += `<button onclick="toggleMatrixNum(this, ${val})" class="matrix-btn w-16 h-16 rounded-xl border border-stone-700 bg-stone-900 text-stone-500 font-mono text-xl font-bold hover:border-green-500/50 transition-all">${val}</button>`;
            });
            gridHtml += '</div>';
            
            container.innerHTML = `
                <div class="flex flex-col items-center">
                    <div class="mb-8 text-center">
                        <div class="text-xs text-stone-500 uppercase tracking-widest mb-2">Desplazamiento Actual</div>
                        <div id="matrix-sum" class="text-6xl font-mono text-stone-300 font-light">00</div>
                        <div class="text-xs text-green-700 mt-2 font-mono">OBJETIVO: Sincronizar Delta</div>
                    </div>
                    ${gridHtml}
                    <button onclick="checkMatrixSum()" class="mt-4 px-10 py-3 bg-green-900/20 border border-green-800 text-green-400 rounded-lg uppercase tracking-widest text-sm font-bold hover:bg-green-900/40">
                        SINCRONIZAR
                    </button>
                </div>
            `;
        }
        
        function toggleMatrixNum(btn, val) {
            if (btn.classList.contains('bg-green-600')) {
                // Deselect
                btn.classList.remove('bg-green-600', 'text-black', 'border-green-400');
                btn.classList.add('bg-stone-900', 'text-stone-500', 'border-stone-700');
                gameInternalState.currentSum -= val;
            } else {
                // Select
                btn.classList.remove('bg-stone-900', 'text-stone-500', 'border-stone-700');
                btn.classList.add('bg-green-600', 'text-black', 'border-green-400');
                gameInternalState.currentSum += val;
            }
            document.getElementById('matrix-sum').innerText = gameInternalState.currentSum.toString().padStart(2, '0');
        }
        
        function checkMatrixSum() {
            if (gameInternalState.currentSum.toString() === activeLevelData.answer) {
                completeLevelLogic();
            } else {
                showSystemMessage(`ERROR DE PARALAJE: ${gameInternalState.currentSum} != OBJ`, "error");
                // Reset visual simple
                document.getElementById('matrix-sum').classList.add('text-red-500');
                setTimeout(() => document.getElementById('matrix-sum').classList.remove('text-red-500'), 500);
            }
        }

        // --- DIAL ---
        function renderDial(container) {
            gameInternalState.inputValue = "0";
            container.innerHTML = `
                <div class="w-full max-w-[400px] space-y-12 animate-in fade-in flex flex-col items-center">
                    <div id="dial-value" class="text-8xl font-extralight text-stone-300 font-mono tracking-tighter">0</div>
                    <div class="w-full px-4">
                        <input type="range" id="tension-slider" min="0" max="30" value="0" step="1" 
                            oninput="updateDialVisual(this.value)" 
                            class="w-full">
                    </div>
                    <button onclick="checkDialAnswer()" 
                        class="px-12 py-4 bg-green-900/10 border border-green-700/30 text-green-400 rounded-2xl uppercase font-bold tracking-widest hover:bg-green-800/20 transition-all">
                        ESTABLECER VALOR
                    </button>
                    <p class="text-[10px] text-stone-600 font-mono uppercase tracking-widest text-center">Protocolo de ajuste de intensidad</p>
                </div>
            `;
        }
        function updateDialVisual(val) {
            gameInternalState.inputValue = val; 
            const display = document.getElementById('dial-value'); 
            display.innerText = val;
            display.className = "text-8xl font-extralight text-stone-300 font-mono tracking-tighter";
        }
        function checkDialAnswer() {
            if (gameInternalState.inputValue === activeLevelData.answer) {
                completeLevelLogic();
            } else {
                showSystemMessage("VALOR INCORRECTO. SIGUE INTENTANDO.", "error");
                document.getElementById('modal-overlay').classList.add('animate-shake');
                setTimeout(() => document.getElementById('modal-overlay').classList.remove('animate-shake'), 300);
            }
        }

        // --- PAD NUMÉRICO ---
        function renderPad(container) {
            gameInternalState.input = "";
            container.innerHTML = `<div id="pad-disp" class="w-80 bg-black p-8 mb-8 text-center font-mono text-4xl border border-green-900/40 rounded-3xl text-green-100 tracking-widest font-bold">...</div><div id="pad-grid" class="grid grid-cols-3 gap-5 w-80"></div><div class="flex gap-4 w-80 mt-8"><button onclick="updPad('C')" class="flex-1 p-5 bg-stone-800 text-stone-500 rounded-2xl text-xs font-bold uppercase">Borrar</button><button onclick="checkAns()" class="flex-1 p-5 bg-green-800 text-white rounded-2xl text-sm font-bold uppercase">Confirmar</button></div>`;
            renderButtons();
        }
        function renderButtons() {
            const nums = [1,2,3,4,5,6,7,8,9,0].sort(() => Math.random()-0.5);
            const grid = document.getElementById('pad-grid'); if (grid) grid.innerHTML = nums.map(n => `<button onclick="updPad(${n})" class="p-6 bg-stone-800 border border-stone-700 rounded-2xl font-mono text-white text-2xl">${n}</button>`).join('');
        }
        function updPad(v) { if (v==='C') gameInternalState.input = ""; else if (gameInternalState.input.length < 8) gameInternalState.input += v; const disp = document.getElementById('pad-disp'); if (disp) disp.innerText = gameInternalState.input || "..."; if(v!=='C') renderButtons(); }
        function checkAns() {
            if (gameInternalState.input === activeLevelData.answer) {
                completeLevelLogic();
            } else { showSystemMessage("CLAVE ERRÓNEA.", "error"); updPad('C'); }
        }

        // Lógica unificada de completado
        function completeLevelLogic() {
            if (!completedLevels.includes(activeLevelData.id)) {
                completedLevels.push(activeLevelData.id);
                // GUARDAR EL TIMESTAMP DEL MOMENTO DE COMPLETADO
                levelTimestamps[activeLevelData.id] = new Date().getTime();
            }
            saveToLocal(true); closeModal(); renderGrid();
            showSystemMessage("ACCESO CONCEDIDO.", "success");
            setTimeout(showStory, 500);
        }

        function showStory() {
            document.getElementById('main-layout').classList.add('hidden');
            document.getElementById('bg-effects').classList.add('hidden');
            const screen = document.getElementById('story-screen'); screen.classList.remove('hidden');
            const container = document.getElementById('story-content'); container.innerHTML = "";
            const visible = RELATIONSHIP_DATA.filter(l => completedLevels.includes(l.id));
            let fullHtml = "";
            visible.forEach(l => {
                fullHtml += `<div class="mb-20 border-l-4 border-green-800 pl-12 pb-6"><span class="text-sm text-green-600 font-mono block mb-6 font-bold tracking-[0.4em] uppercase">LOG_0${l.id} // RECUPERADO</span><div class="text-stone-300 leading-relaxed text-2xl">${l.storyFragment}</div></div>`;
            });
            let i = 0;
            function type() {
                if (i < fullHtml.length) {
                    let char = fullHtml.charAt(i), toAdd = char;
                    if (char === '<') {
                        let tag = ""; while (i < fullHtml.length && fullHtml.charAt(i) !== '>') tag += fullHtml.charAt(i++);
                        if(i < fullHtml.length) tag += '>'; toAdd = tag;
                    }
                    container.innerHTML += toAdd; i++;
                    setTimeout(type, toAdd.length > 1 ? 0 : 20);
                }
            }
            type();
        }
        function closeStory() { document.getElementById('story-screen').classList.add('hidden'); document.getElementById('main-layout').classList.remove('hidden'); document.getElementById('bg-effects').classList.remove('hidden'); }
    </script>
</body>
</html>
