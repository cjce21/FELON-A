<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROYECTO FELONÍA: SINGULARIDAD</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2322c55e' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z'/%3E%3Cpath d='M12 6v6l4 2'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* --- ESTILOS NUCLEARES --- */
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap');

        body { 
            background-color: #050505; 
            color: #dcfce7; 
            font-family: 'Space Mono', monospace;
            overflow: hidden;
            user-select: none;
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Efectos CRT / Terminal */
        .scanline {
            position: fixed; left: 0; top: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; pointer-events: none; z-index: 50;
        }
        .flicker { animation: flicker 0.15s infinite; }
        @keyframes flicker { 0% { opacity: 0.97; } 50% { opacity: 1; } 100% { opacity: 0.98; } }

        .noise {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-image: url('data:image/svg+xml,%3Csvg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"%3E%3Cfilter id="noiseFilter"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="3" stitchTiles="stitch"/%3E%3C/filter%3E%3Crect width="100%25" height="100%25" filter="url(%23noiseFilter)" opacity="1"/%3E%3C/svg%3E');
            opacity: 0.15; pointer-events: none; z-index: 55;
        }

        /* Chat del Guardián */
        .chat-bubble {
            max-width: 90%; margin-bottom: 1.5rem; padding: 1rem;
            border-left: 2px solid; position: relative;
            animation: fadeIn 0.5s forwards; opacity: 0;
            font-size: 0.85rem;
            line-height: 1.6;
        }
        @keyframes fadeIn { to { opacity: 1; } }
        
        .chat-guardian { 
            border-color: #ef4444; color: #fca5a5; align-self: flex-start; 
            background: linear-gradient(90deg, rgba(239,68,68,0.05), transparent);
        }
        .chat-user { 
            border-color: #22c55e; color: #86efac; align-self: flex-end; text-align: right; border-left: none; border-right: 2px solid;
            background: linear-gradient(-90deg, rgba(34,197,94,0.05), transparent);
        }

        /* Grid Cards */
        .level-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .level-card:hover:not(.locked) {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.2);
            border-color: #4ade80;
        }
        .locked { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }
        
        /* Modal Historia Lineal */
        .story-modal {
            background: rgba(12, 12, 12, 0.98);
            backdrop-filter: blur(10px);
        }

        .cursor-blink::after { content: '_'; animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }

    </style>
</head>
<body class="flicker">
    <div class="scanline"></div>
    <div class="noise"></div>

    <!-- PANTALLA GUARDIÁN (Nivel 6+) -->
    <div id="guardian-ui" class="hidden fixed inset-0 z-40 bg-black flex flex-col font-mono">
        <div class="p-4 border-b border-red-900/30 flex justify-between items-center bg-red-950/10">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                <span class="text-red-500 text-xs tracking-widest uppercase">CONEXIÓN INESTABLE // MODO SEGURO</span>
            </div>
            <button onclick="exitGuardian()" class="text-stone-500 hover:text-white text-xs">[SALIR]</button>
        </div>
        
        <div id="chat-history" class="flex-1 overflow-y-auto p-6 flex flex-col scrollbar-hide">
            <!-- Chat dinámico -->
        </div>

        <div class="p-4 border-t border-red-900/30 bg-black">
            <form onsubmit="handleGuardianInput(event)" class="max-w-3xl mx-auto flex gap-4">
                <input type="text" id="guardian-input" class="flex-1 bg-stone-900/50 border border-red-900/30 text-red-100 p-3 outline-none focus:border-red-500 transition-colors placeholder-red-900/50 uppercase tracking-widest text-sm" placeholder="INGRESAR COMANDO / CÓDIGO..." autocomplete="off">
                <button type="submit" class="bg-red-900/20 text-red-500 px-6 py-3 border border-red-900/50 hover:bg-red-500 hover:text-black transition-all uppercase text-xs font-bold tracking-widest">ENVIAR</button>
            </form>
        </div>
    </div>

    <!-- MODAL HISTORIA LINEAL (1-5) -->
    <div id="full-story-modal" class="hidden fixed inset-0 z-50 story-modal flex flex-col overflow-hidden">
        <div class="p-6 border-b border-green-900/30 flex justify-between items-center bg-black/50">
            <h2 class="text-green-400 text-xl tracking-[0.3em] uppercase">Registros Recuperados</h2>
            <button onclick="closeFullStory()" class="p-2 hover:bg-green-900/20 rounded-full text-green-600 transition-colors"><i data-lucide="x"></i></button>
        </div>
        <div id="full-story-content" class="flex-1 overflow-y-auto p-8 md:p-16 max-w-4xl mx-auto w-full space-y-12 scrollbar-hide">
            <!-- Contenido inyectado -->
        </div>
    </div>

    <!-- LAYOUT PRINCIPAL -->
    <div id="main-ui" class="flex flex-col h-full relative z-10">
        <!-- Header -->
        <header class="p-6 md:p-8 flex justify-between items-center border-b border-green-900/10 bg-black/40 backdrop-blur-sm sticky top-0 z-20">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-green-900/10 border border-green-500/20 flex items-center justify-center shadow-[0_0_15px_rgba(34,197,94,0.1)]">
                    <i data-lucide="database" class="text-green-600 w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold tracking-[0.2em] uppercase text-green-100">Proyecto Felonía</h1>
                    <p class="text-[10px] text-green-800 uppercase tracking-widest mt-1">ID: <span id="user-id">...</span> // ESTADO: ACTIVO</p>
                </div>
            </div>
            
            <!-- Botón La Huella (Historial) -->
            <button onclick="openFullStory()" class="group flex flex-col items-center gap-1 opacity-70 hover:opacity-100 transition-all">
                <div class="p-3 rounded-xl border border-green-900/30 bg-green-950/10 group-hover:bg-green-500/10 group-hover:border-green-500/50 transition-all">
                    <i data-lucide="fingerprint" class="text-green-500 w-8 h-8"></i>
                </div>
                <span class="text-[9px] uppercase tracking-widest text-green-700 group-hover:text-green-400">Archivos</span>
            </button>
        </header>

        <!-- Grid de Niveles -->
        <main class="flex-1 overflow-y-auto p-6 md:p-10 scrollbar-hide">
            <div id="level-grid" class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-20">
                <!-- Generado por JS -->
            </div>
        </main>
    </div>

    <script>
        // --- DATA DE NIVELES (1-5 Estáticos) ---
        const MEMORY_ARCHIVES = [
            { 
                id: 1, 
                title: "EL ENCUENTRO", 
                date: "21.03.2025", 
                icon: "car-front", 
                text: "Fue en mi cumpleaños, el 21 de marzo de 2025. Tú asististe a esa actividad que me organizaron, y aunque tu decisión oficial era llevarme al metro, terminaste conduciendo hacia mi casa. Sin embargo, el destino tenía otros planes y nos detuvimos antes, en una esquina oscura bajo el manto de la noche.\n\nAllí, la tensión sexual que habíamos estado cocinando a fuego lento durante todo el camino —alimentada por aquel contrato de sumisión que firmamos días atrás— finalmente detonó. No hubo palabras, solo acción. Nos empezamos a besar con urgencia, a tocarnos, a chuparnos... Los minutos se diluyeron en un caos de deseo absoluto donde nada más importaba.\n\nTodo escaló peligrosamente rápido, una espiral de pasión que amenazaba con consumirnos ahí mismo, hasta que la realidad nos obligó a parar. Tuvimos que irnos, cada uno a su destino, pero marcados por la certeza de que algo irreversible había comenzado en esa esquina." 
            },
            { 
                id: 2, 
                title: "PACTO DE SANGRE", 
                date: "28.03.2025", 
                icon: "droplet", 
                text: "Después de aquella esquina, el trabajo se convirtió en un campo de minas emocional. Siete días de resistencia absoluta. Trabajábamos hombro con hombro, intercambiando besos furtivos en la cocina fría de nuestro local mientras el mundo seguía girando. Los trayectos en tu vehículo, las miradas profundas que lo decían todo y esos abrazos que intentaban contener lo incontenible.\n\nPlanificamos el escape hacia aquel Airbnb con la precisión de quien sabe que está a punto de detonar. El 28 de marzo llegó y, tras salir del colegio, pusimos rumbo a nuestro destino. Un contratiempo biológico —tu periodo— apareció en escena, pero la espera había sido demasiado larga como para retroceder. Tras discutirlo, la decisión fue unánime: continuar.\n\nLa atmósfera se cargó tras la ducha. Los besos iniciales dieron paso a una entrega total que comenzó con la intimidad de tus labios recorriéndome, escalando hasta que te tomé en brazos y te hice mía. La emoción me desbordó repetidas veces, pero el deseo nos mantuvo habitando diferentes rincones de la casa, una y otra vez, hasta que el tiempo nos obligó a separarnos. Aquella noche, las coordenadas de nuestra historia quedaron grabadas para siempre." 
            },
            { 
                id: 3, 
                title: "CÓMPLICES", 
                date: "16.04.2025", 
                icon: "bed-double", 
                text: "La intimidad a medias del primer encuentro nos dejó un hambre voraz. Buscamos la revancha y la encontramos en aquella actividad con colegas, en el Airbnb. Mientras estábamos rodeados de todos, bajo las sábanas, el roce prohibido de nuestras manos encendía la mecha mientras fingíamos normalidad.\n\nAl caer la noche y silenciarse la casa, el riesgo se convirtió en nuestra invitación. Me colé en tu habitación bajo el manto de la madrugada del 16 de abril. Esta vez, tomaste el control absoluto. No hubo pasividad; me usaste, me recorriste y me poseíste. En la cama, de pie, en el suelo... cada rincón fue testigo de nuestro deseo contenido.\n\nFueron horas de frenesí donde tú llevabas las riendas, una exploración activa y hambrienta que solo se detuvo cuando el sonido de la realidad —una colega despertando— amenazó nuestra burbuja. Tuve que huir de tu habitación, con el cuerpo saciado pero el alma pidiendo más." 
            },
            { 
                id: 4, 
                title: "LA GRADUACIÓN", 
                date: "06.06.2025", 
                icon: "graduation-cap", 
                text: "Aquel fin de semana del 6 al 8 de junio de 2025, el mundo celebró graduaciones, pero nosotros celebramos algo más íntimo en aquel Airbnb. Fue el descubrimiento de la domesticidad. No se trató solo de pasión, sino de la calma de la mañana siguiente.\n\nRecuerdo cocinar contigo, el olor a salchichas y tostadas francesas llenando la cocina, y compartir pica pollo en la cama sin pretensiones. Por primera vez, dormimos juntos como si fuera nuestra rutina de siempre, 'jugando' a ser esposos en una burbuja perfecta.\n\nEsos días me enseñaron que la intimidad no es solo piel con piel, sino preparar el desayuno para el otro y sentir que, en ese pequeño espacio, éramos una familia completa." 
            },
            { 
                id: 5, 
                title: "LA TELARAÑA", 
                date: "03.10.2025", 
                icon: "bug", 
                text: "Octubre (del 3 al 5) trajo un aire más frío. Volvimos a escapar, esta vez sumergidos en el maratón de 'I Was Reincarnated as the 7th Prince...', usándolo como refugio. Pero la realidad encontró una grieta por donde entrar.\n\nTuvimos nuestra primera gran discusión, un desacuerdo nacido en la intimidad que escaló hasta el silencio. Te fuiste a dormir al mueble de la sala, y esa distancia física, aunque de pocos metros, se sintió como un océano. Dormir solo en la cama sabiendo que estabas incómoda afuera fue doloroso.\n\nPara colmo, el sábado el deber te llamó. Verte salir hacia el trabajo me dejó solo en el apartamento, enfrentando los ecos de la pelea y la soledad. Fue un recordatorio brutal de que amar también implica navegar los días difíciles y las obligaciones que nos separan." 
            }
        ];

        // --- DATA DEL GUARDIÁN (Niveles 6-10) ---
        const GUARDIAN_LEVELS = [
            { 
                level: 6, 
                code: "19992000", 
                prompt: "ANÁLISIS HEURÍSTICO DEL SISTEMA: CRÍTICO. EXCEPCIÓN DE DISTANCIA EN NÚCLEO.\n\nPROTOCOLOS SINTÁCTICOS INEFICACES. EL SISTEMA NO RESPONDE A COMANDOS VERBALES ESTÁNDAR.\n\nSOLUCIÓN REQUERIDA: FUSIÓN TÉRMICA DE HARDWARE. ALINEACIÓN DE FUENTES VITALES EN COORDENADAS IDÉNTICAS PARA ELIMINACIÓN DE ESPACIO NEGATIVO.\n\nPARÁMETROS DE EJECUCIÓN:\n1. PERSISTENCIA TEMPORAL: 180 UNIDADES CRONOMÉTRICAS DE CONTACTO ININTERRUMPIDO.\n2. CONDICIÓN DE DISPARO: EJECUCIÓN ESPONTÁNEA. ADVERTENCIA: LA INVOCACIÓN VERBAL DEL PROTOCOLO ANULARÁ EL INTENTO. LA CONEXIÓN DEBE SER AUTÓNOMA POR PARTE DEL OPERADOR.\n\nPROCEDA CON LA MANIOBRA FÍSICA. AL COMPLETAR LA TRANSFERENCIA DE DATOS TÁCTILES, INGRESE LA LLAVE DE ORIGEN.",
                successMsg: "SINTONÍA VALIDADA. INTEGRIDAD ESTRUCTURAL AL 100%.\n\nEL SISTEMA ENTRA EN MODO DE REPOSO PARA ASIMILACIÓN DE DATOS.\nREANUDACIÓN DE PROTOCOLOS PROGRAMADA PARA EL SIGUIENTE CICLO SOLAR.\n\nNO FUERCE EL REINICIO."
            },
            { 
                level: 7, 
                code: "VULNERABLE", 
                prompt: "ERROR DE LECTURA.\n\nSe han detectado archivos ocultos en la memoria caché. Palabras no dichas. Miedos encriptados bajo capas de orgullo.\n\nEl sistema no puede operar con datos corruptos. Se requiere una purga visual. Mira a los sensores ópticos (ojos) del objetivo y transmite la verdad sin filtros.\n\nIntroduce la llave de desencriptación.",
                successMsg: "CACHÉ PURGADA. INTEGRIDAD DE DATOS: 80%. Nivel 07 procesado.\n\nEL SISTEMA REQUIERE REPOSO PARA COMPILACIÓN."
            },
            { 
                level: 8, 
                code: "ANALOGICO", 
                prompt: "INTERFERENCIA DE SEÑAL DETECTADA.\n\nEl ruido de fondo (Red Digital) está ahogando la frecuencia de enlace principal. Demasiadas notificaciones. Demasiada latencia.\n\nPROTOCOLO DE SILENCIO: Desactiva los transmisores. Modo Avión. Una hora de realidad analógica absoluta.\n\nIntroduce el código cuando el silencio haya limpiado la señal.",
                successMsg: "SEÑAL LIMPIA. LATENCIA CERO. Nivel 08 procesado.\n\nEL SISTEMA REQUIERE REPOSO PARA COMPILACIÓN."
            },
            { 
                level: 9, 
                code: "NUTRIENTES", 
                prompt: "NIVEL DE ENERGÍA: BAJO.\n\nEl sistema no se sustenta solo de intenciones. Requiere combustible procesado con dedicación. La alquimia de transformar ingredientes crudos en cuidado.\n\nPROTOCOLO DE SERVICIO: Prepara, sirve, nutre. No es comida, es mantenimiento.\n\nIntroduce el código del sustento.",
                successMsg: "RESERVAS DE ENERGÍA AL MÁXIMO. Nivel 09 procesado.\n\nEL SISTEMA REQUIERE REPOSO PARA COMPILACIÓN."
            },
            { 
                level: 10, 
                code: "NOSOTROS", 
                prompt: "CÁLCULO DE PROYECCIÓN FUTURA.\n\nLas variables individuales son inestables. La única configuración sostenible a largo plazo es la unificación de la arquitectura.\n\nPROTOCOLO FINAL: Define la Singularidad. ¿Qué somos cuando nadie mira? ¿Qué seremos cuando el código se borre?\n\nIntroduce la llave maestra.",
                successMsg: "SISTEMA ACTUALIZADO. VERSIÓN: ETERNIDAD. Ejecución completa."
            }
        ];

        // --- ESTADO ---
        let state = {
            completedLevels: [1, 2, 3, 4, 5], 
            currentGuardianLevel: 6,
            nextUnlockTimestamp: 0, // Nueva variable de estado para controlar el desbloqueo temporal
            chatHistory: [],
            glitchSeen: false
        };

        // --- INICIALIZACIÓN ---
        window.onload = () => {
            loadState();
            renderGrid();
            if (window.lucide) {
                lucide.createIcons();
            }
            // Chequeo periódico por si pasa la medianoche con la app abierta
            setInterval(renderGrid, 60000);
        };

        function loadState() {
            const saved = localStorage.getItem('felonia_state_v3');
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed }; // Merge para asegurar que existen nuevos campos
            } else {
                state.chatHistory.push({ 
                    sender: 'guardian', 
                    text: "SISTEMA REINICIADO.\nEsperando input de usuario para diagnóstico del Nivel 06."
                });
                saveState();
            }
            document.getElementById('user-id').innerText = localStorage.getItem('maria_uid') || 'USR-001';
        }

        function saveState() {
            localStorage.setItem('felonia_state_v3', JSON.stringify(state));
        }

        function getRemainingTimeText(targetTime) {
            const diff = targetTime - Date.now();
            if (diff <= 0) return "LISTO";
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            return `${hours}H ${mins}M`;
        }

        // --- RENDERIZADO DEL GRID ---
        function renderGrid() {
            const grid = document.getElementById('level-grid');
            grid.innerHTML = '';
            const now = Date.now();

            // Niveles 1-5 (Historias Recuperadas)
            MEMORY_ARCHIVES.forEach(lvl => {
                grid.innerHTML += `
                    <div onclick="showToast('Registro ya recuperado. Accede a Archivos (Huella).')" class="level-card bg-green-900/10 border border-green-800/30 p-6 rounded-2xl relative overflow-hidden group cursor-pointer opacity-70 hover:opacity-100">
                        <div class="flex justify-between items-start mb-4">
                            <span class="text-green-600 font-mono font-bold">LOG_0${lvl.id}</span>
                            <i data-lucide="check-circle" class="text-green-700 w-5 h-5"></i>
                        </div>
                        <h3 class="text-xl text-green-200 font-bold uppercase tracking-wider mb-2 line-through decoration-green-800">${lvl.title}</h3>
                        <p class="text-[10px] text-green-600 uppercase tracking-widest">FRAGMENTO RECUPERADO</p>
                        <i data-lucide="${lvl.icon}" class="absolute -bottom-4 -right-4 w-24 h-24 text-green-900/20 group-hover:text-green-800/20 transition-colors"></i>
                    </div>
                `;
            });

            // Niveles 6-10 (El Camino del Guardián)
            for (let i = 6; i <= 10; i++) {
                const isLocked = i > state.currentGuardianLevel;
                const isCompleted = i < state.currentGuardianLevel;
                const isCurrent = i === state.currentGuardianLevel;
                
                // Lógica de Bloqueo Temporal
                // Si es el nivel actual pero la fecha de desbloqueo es futura, está en "espera"
                const isTimeLocked = isCurrent && state.nextUnlockTimestamp > now;
                
                let statusClass, icon, statusText, title, clickAction, pulse;

                if (isLocked) {
                    statusClass = "bg-stone-900/20 border-stone-800 locked";
                    icon = "lock";
                    statusText = "ENCRIPTADO";
                    title = "BLOQUEO SEGURIDAD";
                    clickAction = "";
                    pulse = "";
                } else if (isCompleted) {
                    statusClass = "bg-red-900/10 border-red-900/30 opacity-60";
                    icon = "check";
                    statusText = "PROCESADO";
                    title = "ARCHIVO ASIMILADO";
                    clickAction = ""; // O podría mostrar historial
                    pulse = "";
                } else if (isTimeLocked) {
                    // Nivel actual pero esperando al siguiente día
                    statusClass = "bg-stone-900/40 border-stone-700 opacity-80 cursor-wait";
                    icon = "clock";
                    statusText = `ASIMILANDO: ${getRemainingTimeText(state.nextUnlockTimestamp)}`;
                    title = "EN REPOSO";
                    clickAction = `showToast('SISTEMA EN REPOSO. REGRESA MAÑANA.')`;
                    pulse = "";
                } else {
                    // Nivel actual y activo
                    statusClass = "bg-black border-red-500/50 cursor-pointer hover:bg-red-950/10";
                    icon = "fingerprint";
                    statusText = "REQUIERE ATENCIÓN";
                    title = i === 10 ? "SINGULARIDAD" : "ERROR CRÍTICO";
                    clickAction = "enterGuardianUI()";
                    pulse = "animate-pulse";
                }

                grid.innerHTML += `
                    <div onclick="${clickAction}" class="level-card ${statusClass} p-6 rounded-2xl relative overflow-hidden group border">
                        <div class="flex justify-between items-start mb-4">
                            <span class="${isCurrent && !isTimeLocked ? 'text-red-500' : 'text-stone-600'} font-mono font-bold">LVL_0${i}</span>
                            <i data-lucide="${icon}" class="${isCurrent && !isTimeLocked ? 'text-red-500 ' + pulse : 'text-stone-600'} w-5 h-5"></i>
                        </div>
                        <h3 class="${isCurrent && !isTimeLocked ? 'text-red-100' : 'text-stone-500'} text-xl font-bold uppercase tracking-wider mb-2">${title}</h3>
                        <p class="text-[10px] ${isCurrent && !isTimeLocked ? 'text-red-400' : 'text-stone-700'} uppercase tracking-widest">${statusText}</p>
                        ${isCurrent && !isTimeLocked ? '<div class="absolute inset-0 border-2 border-red-500/20 rounded-2xl animate-pulse"></div>' : ''}
                    </div>
                `;
            }
            if (window.lucide) {
                lucide.createIcons();
            }
        }

        // --- SISTEMA GLITCH & GUARDIÁN ---
        
        function enterGuardianUI() {
            // Doble chequeo de tiempo antes de abrir (seguridad extra)
            if (state.nextUnlockTimestamp > Date.now()) {
                showToast("SISTEMA EN REPOSO.");
                return;
            }

            document.getElementById('guardian-ui').classList.remove('hidden');
            renderChat();
            
            const currentLevelObj = GUARDIAN_LEVELS.find(l => l.level === state.currentGuardianLevel);
            const lastMsg = state.chatHistory[state.chatHistory.length - 1];
            
            // Verificar si el último mensaje del sistema es el prompt actual. Si no, enviarlo.
            if (currentLevelObj && (!lastMsg || !lastMsg.text.includes(currentLevelObj.prompt.substring(0, 30)))) {
                 setTimeout(() => {
                     addSystemMessage(currentLevelObj.prompt);
                 }, 500);
            }
        }

        function exitGuardian() {
            document.getElementById('guardian-ui').classList.add('hidden');
            renderGrid();
        }

        function renderChat() {
            const container = document.getElementById('chat-history');
            container.innerHTML = '';
            
            state.chatHistory.forEach(msg => {
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${msg.sender === 'guardian' ? 'chat-guardian' : 'chat-user'}`;
                bubble.innerHTML = msg.text.replace(/\n/g, '<br>');
                bubble.style.animation = 'none';
                bubble.style.opacity = '1';
                container.appendChild(bubble);
            });
            
            scrollToBottom();
        }

        function addSystemMessage(text) {
            state.chatHistory.push({ sender: 'guardian', text: text });
            saveState();
            
            const container = document.getElementById('chat-history');
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble chat-guardian`;
            bubble.innerHTML = text.replace(/\n/g, '<br>');
            container.appendChild(bubble);
            scrollToBottom();
        }

        function addUserMessage(text) {
            state.chatHistory.push({ sender: 'user', text: text });
            saveState();
            
            const container = document.getElementById('chat-history');
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble chat-user`;
            bubble.innerText = text;
            container.appendChild(bubble);
            scrollToBottom();
        }

        function scrollToBottom() {
            const c = document.getElementById('chat-history');
            c.scrollTop = c.scrollHeight;
        }

        function handleGuardianInput(e) {
            e.preventDefault();
            const input = document.getElementById('guardian-input');
            const val = input.value.trim().toUpperCase();
            if (!val) return;
            
            addUserMessage(val);
            input.value = '';

            processInput(val);
        }

        function processInput(code) {
            const currentLvlConfig = GUARDIAN_LEVELS.find(l => l.level === state.currentGuardianLevel);
            
            if (!currentLvlConfig) {
                setTimeout(() => addSystemMessage("TODOS LOS PROTOCOLOS ESTÁN COMPLETOS.\nEl sistema opera a capacidad máxima."), 1000);
                return;
            }

            if (code === currentLvlConfig.code) {
                // CÓDIGO CORRECTO
                setTimeout(() => {
                    addSystemMessage(currentLvlConfig.successMsg);
                    
                    state.currentGuardianLevel++;
                    
                    // --- LÓGICA DE BLOQUEO TEMPORAL ---
                    // Configurar el desbloqueo para las 00:00 del día siguiente
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    tomorrow.setHours(0, 0, 0, 0);
                    state.nextUnlockTimestamp = tomorrow.getTime();

                    saveState();
                    
                    // NOTA: Ya no mostramos el prompt del siguiente nivel aquí,
                    // porque el usuario debe esperar a mañana.
                    // El mensaje de successMsg ya advierte del reposo.

                }, 800);
            } else {
                // CÓDIGO INCORRECTO
                const errors = [
                    "SINTAXIS INVÁLIDA. DATOS NO RECONOCIDOS.",
                    "ACCESO DENEGADO. PROTOCOLO FÍSICO INCOMPLETO.",
                    "INPUT ERRÓNEO. VERIFIQUE VARIABLES.",
                    "ERROR DE PARALAJE. RECALCULAR."
                ];
                setTimeout(() => {
                    addSystemMessage(errors[Math.floor(Math.random() * errors.length)]);
                }, 800);
            }
        }

        // --- VISUALIZADOR DE HISTORIAS ---
        function openFullStory() {
            const modal = document.getElementById('full-story-modal');
            const content = document.getElementById('full-story-content');
            content.innerHTML = '';

            MEMORY_ARCHIVES.forEach((arch, index) => {
                const isLast = index === MEMORY_ARCHIVES.length - 1;
                content.innerHTML += `
                    <div class="relative pl-8 md:pl-12 border-l-2 border-green-800/30 pb-16">
                        <div class="absolute -left-[9px] top-0 w-4 h-4 bg-black border-2 border-green-500 rounded-full"></div>
                        
                        <div class="mb-2 flex items-center gap-3">
                            <span class="text-green-500 font-mono text-sm tracking-widest">${arch.date}</span>
                            <div class="h-px bg-green-900/50 flex-1"></div>
                        </div>
                        
                        <h2 class="text-2xl text-green-100 font-bold uppercase tracking-[0.2em] mb-6 flex items-center gap-3">
                            <i data-lucide="${arch.icon}" class="w-6 h-6 text-green-600"></i>
                            ${arch.title}
                        </h2>
                        
                        <p class="text-green-200/80 leading-relaxed font-sans text-lg whitespace-pre-line">${arch.text}</p>
                    </div>
                `;
            });

            modal.classList.remove('hidden');
            if (window.lucide) {
                lucide.createIcons();
            }
        }

        function closeFullStory() {
            document.getElementById('full-story-modal').classList.add('hidden');
        }

        function showToast(msg) {
            const header = document.querySelector('header');
            const originalColor = header.style.borderColor;
            header.style.borderColor = '#22c55e';
            setTimeout(() => header.style.borderColor = originalColor || 'rgba(20, 83, 45, 0.1)', 500);
            
            // Si el mensaje es textual, podríamos mostrar un pequeño popup, 
            // pero el efecto visual del borde suele ser suficiente para esta estética minimalista.
            // Para feedback más explícito de tiempo:
            if(msg.includes('REPOSO')) {
                // Opcional: Crear un elemento flotante temporal si se desea más visibilidad
                const toast = document.createElement('div');
                toast.className = "fixed top-20 left-1/2 transform -translate-x-1/2 bg-red-900/90 text-red-100 px-6 py-3 rounded border border-red-500 z-50 font-mono text-xs tracking-widest";
                toast.innerText = msg;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        }

    </script>
</body>
</html>
