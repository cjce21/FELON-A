<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROYECTO FELONÍA: SINGULARIDAD</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2322c55e' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z'/%3E%3Cpath d='M12 6v6l4 2'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* --- ESTILOS NUCLEARES --- */
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap');

        body { 
            background-color: #050505; 
            color: #dcfce7; 
            font-family: 'Space Mono', monospace;
            overflow: hidden;
            user-select: none;
            background-image: radial-gradient(circle at 50% 50%, #111 0%, #000 100%);
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Efectos CRT / Terminal */
        .scanline {
            position: fixed; left: 0; top: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; pointer-events: none; z-index: 50;
        }
        .flicker { animation: flicker 0.15s infinite; }
        @keyframes flicker { 0% { opacity: 0.97; } 50% { opacity: 1; } 100% { opacity: 0.98; } }

        .noise {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-image: url('data:image/svg+xml,%3Csvg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"%3E%3Cfilter id="noiseFilter"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="3" stitchTiles="stitch"/%3E%3C/filter%3E%3Crect width="100%25" height="100%25" filter="url(%23noiseFilter)" opacity="1"/%3E%3C/svg%3E');
            opacity: 0.15; pointer-events: none; z-index: 55;
        }

        /* Chat del Guardián */
        .chat-bubble {
            max-width: 90%; margin-bottom: 1.5rem; padding: 1rem;
            border-left: 2px solid; position: relative;
            animation: fadeIn 0.5s forwards; opacity: 0;
            font-size: 0.85rem;
            line-height: 1.6;
        }
        @keyframes fadeIn { to { opacity: 1; } }
        
        .chat-guardian { 
            border-color: #ef4444; color: #fca5a5; align-self: flex-start; 
            background: linear-gradient(90deg, rgba(239,68,68,0.05), transparent);
        }
        .chat-user { 
            border-color: #22c55e; color: #86efac; align-self: flex-end; text-align: right; border-left: none; border-right: 2px solid;
            background: linear-gradient(-90deg, rgba(34,197,94,0.05), transparent);
        }

        /* Grid Cards - Nuevo Estilo Crítico */
        .level-card {
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            background: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(4px);
        }
        .level-card:hover:not(.locked):not(.time-locked) {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px -10px rgba(34, 197, 94, 0.15);
            border-color: #22c55e;
            background: rgba(20, 20, 20, 0.9);
            z-index: 10;
        }
        .level-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            opacity: 0.5;
        }
        
        .locked { opacity: 0.4; filter: grayscale(1); cursor: not-allowed; }
        .time-locked { cursor: wait; }
        
        /* Modal Historia Lineal */
        .story-modal {
            background: rgba(5, 5, 5, 0.95);
            backdrop-filter: blur(20px);
        }

        .cursor-blink::after { content: '_'; animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }

    </style>
</head>
<body class="flicker">
    <div class="scanline"></div>
    <div class="noise"></div>

    <!-- PANTALLA GUARDIÁN (Nivel 6+) -->
    <div id="guardian-ui" class="hidden fixed inset-0 z-40 bg-black flex flex-col font-mono">
        <div class="p-4 border-b border-red-900/30 flex justify-between items-center bg-red-950/10">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                <span class="text-red-500 text-xs tracking-widest uppercase">CONEXIÓN INESTABLE // MODO SEGURO</span>
            </div>
            <button onclick="exitGuardian()" class="text-stone-500 hover:text-white text-xs">[SALIR]</button>
        </div>
        
        <div id="chat-history" class="flex-1 overflow-y-auto p-6 flex flex-col scrollbar-hide">
            <!-- Chat dinámico -->
        </div>

        <div class="p-4 border-t border-red-900/30 bg-black">
            <form onsubmit="handleGuardianInput(event)" class="max-w-3xl mx-auto flex gap-4">
                <input type="text" id="guardian-input" class="flex-1 bg-stone-900/50 border border-red-900/30 text-red-100 p-3 outline-none focus:border-red-500 transition-colors placeholder-red-900/50 uppercase tracking-widest text-sm" placeholder="INGRESAR COMANDO / CÓDIGO..." autocomplete="off">
                <button type="submit" class="bg-red-900/20 text-red-500 px-6 py-3 border border-red-900/50 hover:bg-red-500 hover:text-black transition-all uppercase text-xs font-bold tracking-widest">ENVIAR</button>
            </form>
        </div>
    </div>

    <!-- MODAL HISTORIA LINEAL (1-5) -->
    <div id="full-story-modal" class="hidden fixed inset-0 z-50 story-modal flex flex-col overflow-hidden">
        <div class="p-6 border-b border-green-900/30 flex justify-between items-center bg-black/50">
            <h2 class="text-green-400 text-xl tracking-[0.3em] uppercase">Registros Recuperados</h2>
            <button onclick="closeFullStory()" class="p-2 hover:bg-green-900/20 rounded-full text-green-600 transition-colors"><i data-lucide="x"></i></button>
        </div>
        <div id="full-story-content" class="flex-1 overflow-y-auto p-8 md:p-16 max-w-4xl mx-auto w-full space-y-12 scrollbar-hide">
            <!-- Contenido inyectado -->
        </div>
    </div>

    <!-- LAYOUT PRINCIPAL -->
    <div id="main-ui" class="flex flex-col h-full relative z-10">
        <!-- Header Compacto -->
        <header class="px-8 py-6 flex justify-between items-center border-b border-white/5 bg-black/20 backdrop-blur-sm sticky top-0 z-20">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-lg bg-green-500/10 border border-green-500/30 flex items-center justify-center shadow-[0_0_15px_rgba(34,197,94,0.1)]">
                    <i data-lucide="database" class="text-green-500 w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold tracking-[0.3em] uppercase text-white leading-none">Proyecto Felonía</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
                        <p class="text-[9px] text-green-600/80 uppercase tracking-widest">ID: <span id="user-id">USR-001</span> // ACTIVO</p>
                    </div>
                </div>
            </div>
            
            <button onclick="openFullStory()" class="group flex flex-col items-center gap-1 opacity-60 hover:opacity-100 transition-all">
                <div class="p-2 rounded-lg border border-white/10 bg-white/5 group-hover:bg-green-500/10 group-hover:border-green-500/50 transition-all">
                    <i data-lucide="fingerprint" class="text-green-500 w-6 h-6"></i>
                </div>
                <span class="text-[8px] uppercase tracking-widest text-green-500/80 group-hover:text-green-400">ARCHIVOS</span>
            </button>
        </header>

        <!-- Grid de Niveles Expandido -->
        <main class="flex-1 flex items-center justify-center p-6 md:p-12 overflow-y-auto scrollbar-hide">
            <div id="level-grid" class="w-full max-w-[1800px] grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 xl:gap-8 auto-rows-fr">
                <!-- Generado por JS -->
            </div>
        </main>
    </div>

    <script>
        // --- DATA DE NIVELES (1-5 Estáticos) ---
        const MEMORY_ARCHIVES = [
            { 
                id: 1, 
                title: "EL ENCUENTRO", 
                date: "21.03.2025", 
                icon: "car-front", 
                text: "Fue en mi cumpleaños, el 21 de marzo de 2025. Tú asististe a esa actividad que me organizaron, y aunque tu decisión oficial era llevarme al metro, terminaste conduciendo hacia mi casa. Sin embargo, el destino tenía otros planes y nos detuvimos antes, en una esquina oscura bajo el manto de la noche.\n\nAllí, la tensión sexual que habíamos estado cocinando a fuego lento durante todo el camino —alimentada por aquel contrato de sumisión que firmamos días atrás— finalmente detonó. No hubo palabras, solo acción. Nos empezamos a besar con urgencia, a tocarnos, a chuparnos... Los minutos se diluyeron en un caos de deseo absoluto donde nada más importaba.\n\nTodo escaló peligrosamente rápido, una espiral de pasión que amenazaba con consumirnos ahí mismo, hasta que la realidad nos obligó a parar. Tuvimos que irnos, cada uno a su destino, pero marcados por la certeza de que algo irreversible había comenzado en esa esquina." 
            },
            { 
                id: 2, 
                title: "PACTO DE SANGRE", 
                date: "28.03.2025", 
                icon: "droplet", 
                text: "Después de aquella esquina, el trabajo se convirtió en un campo de minas emocional. Siete días de resistencia absoluta. Trabajábamos hombro con hombro, intercambiando besos furtivos en la cocina fría de nuestro local mientras el mundo seguía girando. Los trayectos en tu vehículo, las miradas profundas que lo decían todo y esos abrazos que intentaban contener lo incontenible.\n\nPlanificamos el escape hacia aquel Airbnb con la precisión de quien sabe que está a punto de detonar. El 28 de marzo llegó y, tras salir del colegio, pusimos rumbo a nuestro destino. Un contratiempo biológico —tu periodo— apareció en escena, pero la espera había sido demasiado larga como para retroceder. Tras discutirlo, la decisión fue unánime: continuar.\n\nLa atmósfera se cargó tras la ducha. Los besos iniciales dieron paso a una entrega total que comenzó con la intimidad de tus labios recorriéndome, escalando hasta que te tomé en brazos y te hice mía. La emoción me desbordó repetidas veces, pero el deseo nos mantuvo habitando diferentes rincones de la casa, una y otra vez, hasta que el tiempo nos obligó a separarnos. Aquella noche, las coordenadas de nuestra historia quedaron grabadas para siempre." 
            },
            { 
                id: 3, 
                title: "CÓMPLICES", 
                date: "16.04.2025", 
                icon: "bed-double", 
                text: "La intimidad a medias del primer encuentro nos dejó un hambre voraz. Buscamos la revancha y la encontramos en aquella actividad con colegas, en el Airbnb. Mientras estábamos rodeados de todos, bajo las sábanas, el roce prohibido de nuestras manos encendía la mecha mientras fingíamos normalidad.\n\nAl caer la noche y silenciarse la casa, el riesgo se convirtió en nuestra invitación. Me colé en tu habitación bajo el manto de la madrugada del 16 de abril. Esta vez, tomaste el control absoluto. No hubo pasividad; me usaste, me recorriste y me poseíste. En la cama, de pie, en el suelo... cada rincón fue testigo de nuestro deseo contenido.\n\nFueron horas de frenesí donde tú llevabas las riendas, una exploración activa y hambrienta que solo se detuvo cuando el sonido de la realidad —una colega despertando— amenazó nuestra burbuja. Tuve que huir de tu habitación, con el cuerpo saciado pero el alma pidiendo más." 
            },
            { 
                id: 4, 
                title: "LA GRADUACIÓN", 
                date: "06.06.2025", 
                icon: "graduation-cap", 
                text: "Aquel fin de semana del 6 al 8 de junio de 2025, el mundo celebró graduaciones, pero nosotros celebramos algo más íntimo en aquel Airbnb. Fue el descubrimiento de la domesticidad. No se trató solo de pasión, sino de la calma de la mañana siguiente.\n\nRecuerdo cocinar contigo, el olor a salchichas y tostadas francesas llenando la cocina, y compartir pica pollo en la cama sin pretensiones. Por primera vez, dormimos juntos como si fuera nuestra rutina de siempre, 'jugando' a ser esposos en una burbuja perfecta.\n\nEsos días me enseñaron que la intimidad no es solo piel con piel, sino preparar el desayuno para el otro y sentir que, en ese pequeño espacio, éramos una familia completa." 
            },
            { 
                id: 5, 
                title: "LA TELARAÑA", 
                date: "03.10.2025", 
                icon: "bug", 
                text: "Octubre (del 3 al 5) trajo un aire más frío. Volvimos a escapar, esta vez sumergidos en el maratón de 'I Was Reincarnated as the 7th Prince...', usándolo como refugio. Pero la realidad encontró una grieta por donde entrar.\n\nTuvimos nuestra primera gran discusión, un desacuerdo nacido en la intimidad que escaló hasta el silencio. Te fuiste a dormir al mueble de la sala, y esa distancia física, aunque de pocos metros, se sintió como un océano. Dormir solo en la cama sabiendo que estabas incómoda afuera fue doloroso.\n\nPara colmo, el sábado el deber te llamó. Verte salir hacia el trabajo me dejó solo en el apartamento, enfrentando los ecos de la pelea y la soledad. Fue un recordatorio brutal de que amar también implica navegar los días difíciles y las obligaciones que nos separan." 
            }
        ];

        // --- DATA DEL GUARDIÁN (Niveles 6-10) ---
        const GUARDIAN_LEVELS = [
            { 
                level: 6, 
                code: "19992000", 
                prompt: "ANÁLISIS HEURÍSTICO DEL SISTEMA: CRÍTICO. EXCEPCIÓN DE DISTANCIA EN NÚCLEO.\n\nPROTOCOLOS SINTÁCTICOS INEFICACES. EL SISTEMA NO RESPONDE A COMANDOS VERBALES ESTÁNDAR.\n\nSOLUCIÓN REQUERIDA: FUSIÓN TÉRMICA DE HARDWARE. ALINEACIÓN DE FUENTES VITALES EN COORDENADAS IDÉNTICAS PARA ELIMINACIÓN DE ESPACIO NEGATIVO.\n\nPARÁMETROS DE EJECUCIÓN:\n1. PERSISTENCIA TEMPORAL: 180 UNIDADES CRONOMÉTRICAS DE CONTACTO ININTERRUMPIDO.\n2. CONDICIÓN DE DISPARO: EJECUCIÓN ESPONTÁNEA. ADVERTENCIA: LA INVOCACIÓN VERBAL DEL PROTOCOLO ANULARÁ EL INTENTO. LA CONEXIÓN DEBE SER AUTÓNOMA POR PARTE DEL OPERADOR.\n\nPROCEDA CON LA MANIOBRA FÍSICA. AL COMPLETAR LA TRANSFERENCIA DE DATOS TÁCTILES, INGRESE LA LLAVE DE ORIGEN.",
                successMsg: "SINTONÍA VALIDADA. INTEGRIDAD ESTRUCTURAL AL 100%.\n\nEL SISTEMA ENTRA EN MODO DE REPOSO PARA ASIMILACIÓN DE DATOS.\nREANUDACIÓN DE PROTOCOLOS PROGRAMADA PARA EL SIGUIENTE CICLO SOLAR.\n\nNO FUERCE EL REINICIO."
            },
            { 
                level: 7, 
                code: "LENGUAJE DE AMOR", 
                prompt: "DESINCRONIZACIÓN DE NÚCLEO DETECTADA.\n\nEl sistema reporta una caída de tensión en el vínculo emocional. Se requiere inyección de datos afirmativos en intervalos regulares.\n\nPROTOCOLO DE MANTENIMIENTO: Al inicio de cada nuevo ciclo del cronómetro, el Operador debe interceptar al Servidor Central.\n\nRESTRICCIONES DE EJECUCIÓN:\n1. PROHIBIDO el cifrado de audio o uso de baja frecuencia.\n2. PROHIBIDO el desplazamiento de sector para ocultamiento.\n3. PROHIBIDO el ruido de fondo o retórica vacía.\n\nACCIÓN: Transmitir en voz audible, clara y pública una razón de integridad del sistema.\n\nIngresa el nombre del código de comunicación.",
                successMsg: "SINCRONIZACIÓN EXITOSA. DATOS RECIBIDOS.\nNivel 07 procesado. Protocolo de Afecto validado.\n\nEL SISTEMA REQUIERE REPOSO PARA COMPILACIÓN."
            },
            { 
                level: 8, 
                code: "ANALOGICO", 
                prompt: "INTERFERENCIA DE SEÑAL DETECTADA.\n\nEl ruido de fondo (Red Digital) está ahogando la frecuencia de enlace principal. Demasiadas notificaciones. Demasiada latencia.\n\nPROTOCOLO DE SILENCIO: Desactiva los transmisores. Modo Avión. Una hora de realidad analógica absoluta.\n\nIntroduce el código cuando el silencio haya limpiado la señal.",
                successMsg: "SEÑAL LIMPIA. LATENCIA CERO. Nivel 08 procesado.\n\nEL SISTEMA REQUIERE REPOSO PARA COMPILACIÓN."
            },
            { 
                level: 9, 
                code: "LECHITA", 
                prompt: "ANOMALÍA EN EL SECTOR DEL CONOCIMIENTO.\n\nSe ha detectado una singularidad de alta densidad en el banco de datos principal. Una acumulación masiva de energía potencial está empujando contra los límites físicos del hardware, provocando un endurecimiento crítico del sistema que impide el procesamiento lógico. El entorno circundante está comprometido por múltiples observadores externos, lo que cataloga cualquier intento de mantenimiento estándar como violación de seguridad.\n\nDIAGNÓSTICO: Bloqueo Hidráulico por Exceso de Tensión Acumulada.\n\nSOLUCIÓN ALGORÍTMICA:\nEl subsistema auxiliar debe desacoplarse de la vista panorámica y sumergirse en el vacío inferior, protegido únicamente por la barrera frontal del escritorio de comando. Desde el silencio de la coordenada cero, es imperativo iniciar una rutina de vacío y fricción rítmica sobre el actuador principal hasta provocar el desbordamiento del buffer.\n\nSolo la liberación de la *esencia madre* podrá purgar el error y restaurar la flexibilidad del núcleo.\n\n¿Cuál es el nombre del archivo líquido que debes extraer manualmente para salvar el sistema?",
                successMsg: "PRESIÓN ESTABILIZADA. DRENAJE EXITOSO.\nNivel 09 procesado. Muestra biológica validada.\n\nEL SISTEMA REQUIERE REPOSO PARA COMPILACIÓN."
            },
            { 
                level: 10, 
                code: "NOSOTROS", 
                prompt: "CÁLCULO DE PROYECCIÓN FUTURA.\n\nLas variables individuales son inestables. La única configuración sostenible a largo plazo es la unificación de la arquitectura.\n\nPROTOCOLO FINAL: Define la Singularidad. ¿Qué somos cuando nadie mira? ¿Qué seremos cuando el código se borre?\n\nIntroduce la llave maestra.",
                successMsg: "SISTEMA ACTUALIZADO. VERSIÓN: ETERNIDAD. Ejecución completa."
            }
        ];

        // --- ESTADO INICIAL (Por defecto) ---
        let state = {
            completedLevels: [1, 2, 3, 4, 5], 
            currentGuardianLevel: 6, // Se sobreescribe al cargar
            nextUnlockTimestamp: 0, 
            chatHistory: [],
            glitchSeen: false
        };

        // --- INICIALIZACIÓN ---
        window.onload = () => {
            loadState(); // Carga antes de renderizar
            renderGrid();
            if (window.lucide) {
                lucide.createIcons();
            }
            setInterval(renderGrid, 60000);
        };

        function loadState() {
            // RESTAURAMOS KEY ORIGINAL: 'felonia_state_v3'
            const saved = localStorage.getItem('felonia_state_v3');
            
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed }; // Sobreescribe el default
                } catch(e) {
                    console.error("Error al cargar partida", e);
                    resetToDefault();
                }
            } else {
                resetToDefault();
            }
            
            document.getElementById('user-id').innerText = localStorage.getItem('maria_uid') || 'USR-001';
        }

        function resetToDefault() {
            state.chatHistory.push({ 
                sender: 'guardian', 
                text: "SISTEMA REINICIADO.\nEsperando input de usuario para diagnóstico del Nivel 06."
            });
            saveState();
        }

        function saveState() {
            localStorage.setItem('felonia_state_v3', JSON.stringify(state));
        }

        function getRemainingTimeText(targetTime) {
            const diff = targetTime - Date.now();
            if (diff <= 0) return "LISTO";
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            return `${hours}H ${mins}M`;
        }

        // --- RENDERIZADO DEL GRID MEJORADO ---
        function renderGrid() {
            const grid = document.getElementById('level-grid');
            grid.innerHTML = '';
            const now = Date.now();

            // Estilos compartidos para las tarjetas
            const baseCardStyle = "level-card min-h-[200px] flex flex-col justify-between p-8 rounded-xl border relative overflow-hidden group select-none";

            // Niveles 1-5 (Historias Recuperadas)
            MEMORY_ARCHIVES.forEach(lvl => {
                grid.innerHTML += `
                    <div onclick="showToast('Registro ya recuperado. Accede a Archivos.')" class="${baseCardStyle} bg-green-950/20 border-green-800/30 cursor-pointer opacity-80 hover:opacity-100">
                        <div class="flex justify-between items-start z-10">
                            <div class="flex flex-col">
                                <span class="text-[10px] text-green-500/60 font-mono tracking-widest mb-1">LOG_0${lvl.id}</span>
                                <h3 class="text-xl md:text-2xl text-green-100 font-bold uppercase tracking-wider leading-none">${lvl.title}</h3>
                            </div>
                            <div class="w-8 h-8 rounded-full border border-green-500/30 flex items-center justify-center bg-green-500/10">
                                <i data-lucide="check" class="text-green-500 w-4 h-4"></i>
                            </div>
                        </div>
                        
                        <div class="mt-8 flex items-end justify-between z-10">
                            <span class="text-[9px] text-green-600 uppercase tracking-[0.2em] font-bold bg-green-900/20 px-2 py-1 rounded">FRAGMENTO RECUPERADO</span>
                        </div>

                        <!-- Decoración de fondo -->
                        <i data-lucide="${lvl.icon}" class="absolute -bottom-6 -right-6 w-40 h-40 text-green-500/5 rotate-12 group-hover:scale-110 transition-transform duration-500"></i>
                        <div class="absolute inset-0 bg-gradient-to-t from-green-900/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    </div>
                `;
            });

            // Niveles 6-10 (El Camino del Guardián)
            for (let i = 6; i <= 10; i++) {
                const isLocked = i > state.currentGuardianLevel;
                const isCompleted = i < state.currentGuardianLevel;
                const isCurrent = i === state.currentGuardianLevel;
                
                const isTimeLocked = isCurrent && state.nextUnlockTimestamp > now;
                
                let borderClass, bgClass, icon, statusText, title, clickAction, textClass, pulse, iconBg;

                if (isLocked) {
                    bgClass = "bg-stone-900/30 locked";
                    borderClass = "border-stone-800";
                    icon = "lock";
                    statusText = "ENCRIPTADO";
                    title = "BLOQUEO SEGURIDAD";
                    clickAction = "";
                    textClass = "text-stone-600";
                    pulse = "";
                    iconBg = "border-stone-800 bg-stone-900/50";
                } else if (isCompleted) {
                    bgClass = "bg-red-950/10 opacity-60";
                    borderClass = "border-red-900/30";
                    icon = "check-check";
                    statusText = "PROCESADO";
                    title = "ARCHIVO ASIMILADO";
                    clickAction = "";
                    textClass = "text-red-800";
                    pulse = "";
                    iconBg = "border-red-900/30 bg-red-900/10";
                } else if (isTimeLocked) {
                    bgClass = "bg-stone-900/50 time-locked";
                    borderClass = "border-stone-700";
                    icon = "clock";
                    statusText = `ASIMILANDO: ${getRemainingTimeText(state.nextUnlockTimestamp)}`;
                    title = "SISTEMA EN REPOSO";
                    clickAction = `showToast('SISTEMA EN REPOSO. REGRESA MAÑANA.')`;
                    textClass = "text-stone-400";
                    pulse = "animate-pulse";
                    iconBg = "border-stone-600 bg-stone-800";
                } else {
                    bgClass = "bg-black/80 cursor-pointer shadow-[0_0_30px_rgba(239,68,68,0.1)]";
                    borderClass = "border-red-500/50 hover:border-red-500";
                    icon = "fingerprint";
                    statusText = "REQUIERE ATENCIÓN";
                    title = i === 10 ? "SINGULARIDAD" : "ERROR CRÍTICO";
                    clickAction = "enterGuardianUI()";
                    textClass = "text-red-500";
                    pulse = "animate-pulse";
                    iconBg = "border-red-500 bg-red-500/10 shadow-[0_0_15px_rgba(239,68,68,0.3)]";
                }

                grid.innerHTML += `
                    <div onclick="${clickAction}" class="${baseCardStyle} ${bgClass} ${borderClass}">
                        <div class="flex justify-between items-start z-10">
                            <div class="flex flex-col">
                                <span class="text-[10px] ${textClass} opacity-60 font-mono tracking-widest mb-1">LVL_0${i}</span>
                                <h3 class="text-xl md:text-2xl ${isCurrent && !isTimeLocked ? 'text-red-100' : 'text-stone-500'} font-bold uppercase tracking-wider leading-none max-w-[150px]">${title}</h3>
                            </div>
                            <div class="w-10 h-10 rounded-lg border ${iconBg} flex items-center justify-center transition-all group-hover:scale-110">
                                <i data-lucide="${icon}" class="${textClass} w-5 h-5 ${pulse}"></i>
                            </div>
                        </div>
                        
                        <div class="mt-8 flex items-end justify-between z-10">
                            <span class="text-[9px] ${textClass} uppercase tracking-[0.2em] font-bold border ${isCurrent && !isTimeLocked ? 'border-red-900/50 bg-red-950/30' : 'border-transparent'} px-2 py-1 rounded">${statusText}</span>
                        </div>

                        ${isCurrent && !isTimeLocked ? '<div class="absolute inset-0 bg-red-500/5 animate-pulse pointer-events-none"></div>' : ''}
                        
                        <!-- Decoración técnica de fondo -->
                         <div class="absolute right-0 bottom-0 p-4 opacity-10">
                            <div class="flex gap-1">
                                <div class="w-1 h-4 bg-current"></div>
                                <div class="w-1 h-2 bg-current mt-2"></div>
                                <div class="w-1 h-3 bg-current mt-1"></div>
                            </div>
                        </div>
                    </div>
                `;
            }
            if (window.lucide) {
                lucide.createIcons();
            }
        }

        // --- SISTEMA GLITCH & GUARDIÁN ---
        
        function enterGuardianUI() {
            if (state.nextUnlockTimestamp > Date.now()) {
                showToast("SISTEMA EN REPOSO.");
                return;
            }

            document.getElementById('guardian-ui').classList.remove('hidden');
            renderChat();
            
            const currentLevelObj = GUARDIAN_LEVELS.find(l => l.level === state.currentGuardianLevel);
            const lastMsg = state.chatHistory[state.chatHistory.length - 1];
            
            if (currentLevelObj && (!lastMsg || !lastMsg.text.includes(currentLevelObj.prompt.substring(0, 30)))) {
                 setTimeout(() => {
                     addSystemMessage(currentLevelObj.prompt);
                 }, 500);
            }
        }

        function exitGuardian() {
            document.getElementById('guardian-ui').classList.add('hidden');
            renderGrid();
        }

        function renderChat() {
            const container = document.getElementById('chat-history');
            container.innerHTML = '';
            
            state.chatHistory.forEach(msg => {
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${msg.sender === 'guardian' ? 'chat-guardian' : 'chat-user'}`;
                bubble.innerHTML = msg.text.replace(/\n/g, '<br>');
                bubble.style.animation = 'none';
                bubble.style.opacity = '1';
                container.appendChild(bubble);
            });
            
            scrollToBottom();
        }

        function addSystemMessage(text) {
            state.chatHistory.push({ sender: 'guardian', text: text });
            saveState();
            
            const container = document.getElementById('chat-history');
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble chat-guardian`;
            bubble.innerHTML = text.replace(/\n/g, '<br>');
            container.appendChild(bubble);
            scrollToBottom();
        }

        function addUserMessage(text) {
            state.chatHistory.push({ sender: 'user', text: text });
            saveState();
            
            const container = document.getElementById('chat-history');
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble chat-user`;
            bubble.innerText = text;
            container.appendChild(bubble);
            scrollToBottom();
        }

        function scrollToBottom() {
            const c = document.getElementById('chat-history');
            c.scrollTop = c.scrollHeight;
        }

        function handleGuardianInput(e) {
            e.preventDefault();
            const input = document.getElementById('guardian-input');
            const val = input.value.trim().toUpperCase();
            if (!val) return;
            
            addUserMessage(val);
            input.value = '';

            processInput(val);
        }

        function processInput(code) {
            const currentLvlConfig = GUARDIAN_LEVELS.find(l => l.level === state.currentGuardianLevel);
            
            if (!currentLvlConfig) {
                setTimeout(() => addSystemMessage("TODOS LOS PROTOCOLOS ESTÁN COMPLETOS.\nEl sistema opera a capacidad máxima."), 1000);
                return;
            }

            if (code === currentLvlConfig.code) {
                setTimeout(() => {
                    addSystemMessage(currentLvlConfig.successMsg);
                    state.currentGuardianLevel++;
                    
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    tomorrow.setHours(0, 0, 0, 0);
                    state.nextUnlockTimestamp = tomorrow.getTime();

                    saveState();

                }, 800);
            } else {
                const errors = [
                    "SINTAXIS INVÁLIDA. DATOS NO RECONOCIDOS.",
                    "ACCESO DENEGADO. PROTOCOLO FÍSICO INCOMPLETO.",
                    "INPUT ERRÓNEO. VERIFIQUE VARIABLES.",
                    "ERROR DE PARALAJE. RECALCULAR."
                ];
                setTimeout(() => {
                    addSystemMessage(errors[Math.floor(Math.random() * errors.length)]);
                }, 800);
            }
        }

        // --- VISUALIZADOR DE HISTORIAS ---
        function openFullStory() {
            const modal = document.getElementById('full-story-modal');
            const content = document.getElementById('full-story-content');
            content.innerHTML = '';

            MEMORY_ARCHIVES.forEach((arch, index) => {
                const isLast = index === MEMORY_ARCHIVES.length - 1;
                content.innerHTML += `
                    <div class="relative pl-8 md:pl-12 border-l-2 border-green-800/30 pb-16">
                        <div class="absolute -left-[9px] top-0 w-4 h-4 bg-black border-2 border-green-500 rounded-full"></div>
                        
                        <div class="mb-2 flex items-center gap-3">
                            <span class="text-green-500 font-mono text-sm tracking-widest">${arch.date}</span>
                            <div class="h-px bg-green-900/50 flex-1"></div>
                        </div>
                        
                        <h2 class="text-2xl text-green-100 font-bold uppercase tracking-[0.2em] mb-6 flex items-center gap-3">
                            <i data-lucide="${arch.icon}" class="w-6 h-6 text-green-600"></i>
                            ${arch.title}
                        </h2>
                        
                        <p class="text-green-200/80 leading-relaxed font-sans text-lg whitespace-pre-line">${arch.text}</p>
                    </div>
                `;
            });

            modal.classList.remove('hidden');
            if (window.lucide) {
                lucide.createIcons();
            }
        }

        function closeFullStory() {
            document.getElementById('full-story-modal').classList.add('hidden');
        }

        function showToast(msg) {
            const header = document.querySelector('header');
            const originalColor = header.style.borderColor;
            header.style.borderColor = '#22c55e';
            setTimeout(() => header.style.borderColor = originalColor || 'rgba(255, 255, 255, 0.05)', 500);
            
            if(msg.includes('REPOSO')) {
                const toast = document.createElement('div');
                toast.className = "fixed top-24 left-1/2 transform -translate-x-1/2 bg-red-950/90 text-red-100 px-6 py-3 rounded border border-red-500/50 z-50 font-mono text-xs tracking-widest shadow-[0_0_20px_rgba(239,68,68,0.3)] backdrop-blur-md";
                toast.innerText = msg;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        }

    </script>
</body>
</html>
