<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROYECTO FELONÍA</title>
    <!-- Favicon: Huella Dactilar Verde -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='none' stroke='%2322c55e' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M2 12C2 6.5 6.5 2 12 2s10 4.5 10 10'/%3E%3Cpath d='M5 15c.5-4 4.5-7 7-7s6.5 3 7 7'/%3E%3Cpath d='M8 18c.5-2.5 2-4.5 4-4.5s3.5 2 4 4.5'/%3E%3Cpath d='M11 21c.5-1 1-1.5 1-1.5s.5.5 1 1.5'/%3E%3Cpath d='M12 12v.01'/%3E%3C/svg%3E">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Ocultar Scrollbar */
        .scrollbar-none::-webkit-scrollbar { display: none; }
        .scrollbar-none { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animaciones */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.3s ease-in-out; }
        
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Cursor parpadeante */
        .cursor-blink::after {
            content: '█';
            animation: blink 1s step-end infinite;
            color: #22c55e;
            margin-left: 2px;
        }
        @keyframes blink { 50% { opacity: 0; } }

        .zoom-in { animation: zoomIn 0.3s ease-out forwards; }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-pulse-soft { animation: pulse-soft 3s infinite; }

        body { 
            background-color: #0c0a09; 
            color: #ecfccb; 
            user-select: none; 
            -webkit-user-select: none;
            overflow: hidden;
        }

        .modal-content-area {
            height: 420px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="font-sans flex flex-col items-center min-h-screen selection:bg-green-700/30" 
      oncontextmenu="return false" 
      ondragstart="return false">

    <!-- INTRO SEQUENCE (Cover) -->
    <div id="intro-screen" class="fixed inset-0 z-[200] bg-black flex flex-col items-center justify-center p-8 font-mono text-green-500">
        <div class="max-w-xl w-full space-y-4">
            <div id="terminal-output" class="text-sm md:text-base leading-relaxed opacity-90 min-h-[200px]"></div>
            <div id="loading-container" class="hidden mt-8 w-full">
                <div class="text-xs mb-1 text-green-400 font-bold uppercase tracking-widest">Iniciando Sistema...</div>
                <div class="w-full bg-stone-900 h-2 border border-green-900/50 rounded-full overflow-hidden">
                    <div id="intro-progress-bar" class="bg-green-600 h-full w-0 shadow-[0_0_15px_rgba(22,163,74,0.4)]"></div>
                </div>
                <div id="intro-percentage" class="text-right text-xs text-green-600 mt-1 font-mono">0%</div>
            </div>
        </div>
    </div>

    <!-- Background con efectos Musgo -->
    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_#1c1917_0%,_#0c0a09_100%)]"></div>
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-green-900/10 blur-[120px] rounded-full animate-pulse-soft"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-emerald-900/10 blur-[120px] rounded-full animate-pulse-soft" style="animation-delay: 1s;"></div>
    </div>

    <!-- PANTALLA DE HISTORIA -->
    <div id="story-screen" class="hidden fixed inset-0 z-[100] bg-stone-950/98 backdrop-blur-xl p-6 md:p-12 flex flex-col items-center justify-start font-serif text-center overflow-y-auto scrollbar-none">
        <div class="max-w-3xl w-full relative z-10 pt-10">
            <button onclick="closeStory()" class="absolute top-0 right-0 text-stone-500 hover:text-green-400 transition-colors">
                <i data-lucide="x" class="w-8 h-8"></i>
            </button>
            <h1 class="text-2xl md:text-3xl text-green-100 uppercase tracking-[0.2em] font-light border-b border-green-900/50 pb-6 mb-8">
                Archivo: Nuestra Historia
            </h1>
            <div id="story-content" class="space-y-8 text-lg text-stone-300 leading-relaxed text-left min-h-[200px] font-mono"></div>
            <div class="mt-20 pt-8 border-t border-green-900/30 text-left font-mono opacity-30 hover:opacity-100 transition-opacity">
                <p class="text-[10px] text-green-700 uppercase mb-2 font-bold tracking-tighter">Sync: Didac-Click Cloud // Persistencia de datos</p>
                <div class="flex flex-col md:flex-row gap-4 items-start md:items-center">
                    <div class="text-[10px] bg-stone-900 p-3 rounded border border-green-900/20 flex-1 w-full overflow-hidden text-ellipsis">
                        SESSION_ID: <span id="display-user-id" class="text-green-500 select-all font-bold">CARGANDO...</span>
                    </div>
                    <button onclick="restoreSessionPrompt()" class="text-[10px] px-4 py-2 bg-green-900/10 border border-green-700/30 text-green-400 hover:bg-green-900/30 rounded transition-all whitespace-nowrap uppercase font-bold tracking-widest">Restaurar Avance</button>
                </div>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <header id="main-header" class="w-full max-w-5xl px-6 py-6 flex justify-between items-center z-10 sticky top-0 opacity-0 transition-opacity duration-1000">
        <button onclick="showStory()" class="flex items-center gap-4 group cursor-pointer hover:opacity-80 transition-opacity text-left">
            <div class="p-2 bg-green-900/10 rounded-lg group-hover:bg-green-900/20 border border-green-900/20 transition-all shadow-[0_0_10px_rgba(22,163,74,0.1)]">
                <i data-lucide="fingerprint" class="text-green-600 w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-xl font-light tracking-[0.3em] text-green-100 uppercase">Proyecto Felonía</h1>
                <p class="text-[9px] text-stone-500 uppercase tracking-[0.2em] group-hover:text-green-400 transition-colors font-bold">Núcleo: Activo</p>
            </div>
        </button>
        <div id="lockout-alert" class="hidden flex items-center gap-3 px-4 py-2 bg-stone-900 border border-green-900/50 rounded-lg text-stone-400 text-xs shadow-[0_0_15px_rgba(20,83,45,0.2)] animate-pulse">
            <i data-lucide="alert-octagon" class="w-3 h-3 text-green-500"></i>
            <span class="font-mono font-bold uppercase tracking-tighter">Abandono Detectado: Bloqueo Temporal Activo</span>
        </div>
    </header>

    <!-- GRID DE NIVELES -->
    <div id="level-grid" class="flex-1 w-full max-w-5xl p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 z-10 overflow-y-auto scrollbar-none pb-20 opacity-0 transition-opacity duration-1000 delay-300"></div>

    <!-- MODAL PRINCIPAL -->
    <div id="modal-overlay" class="hidden fixed inset-0 z-50 bg-stone-950/90 backdrop-blur-md flex items-center justify-center p-4">
        <div class="w-full max-w-3xl bg-stone-900/95 border border-green-800/30 rounded-2xl shadow-[0_0_50px_rgba(0,0,0,0.8)] flex flex-col md:flex-row h-[520px] zoom-in relative overflow-hidden">
            <div class="w-full md:w-1/3 bg-stone-950 p-8 border-b md:border-b-0 md:border-r border-green-900/20 flex flex-col justify-between relative">
                <div class="absolute top-0 left-0 w-full h-1 bg-stone-900">
                    <div id="time-bar" class="h-full bg-gradient-to-r from-green-800 to-green-600 transition-all duration-1000 ease-linear shadow-[0_0_10px_rgba(22,163,74,0.3)]"></div>
                </div>
                <div>
                    <div class="text-[10px] text-green-600 font-mono mb-3 flex items-center gap-2 tracking-widest uppercase font-bold">
                        <i data-lucide="activity" class="w-3 h-3 animate-pulse"></i>
                        <span id="timer-label">Analizando...</span>
                    </div>
                    <div id="timer-display" class="text-5xl font-extralight text-white font-mono tracking-tight">--:--</div>
                </div>
                <div class="space-y-4">
                    <h2 id="modal-title" class="text-xl text-green-100 uppercase tracking-wide font-light">Bloqueado</h2>
                    <p id="modal-desc" class="text-xs text-stone-400 leading-relaxed font-light text-justify"></p>
                </div>
                <div class="text-[9px] text-stone-600 font-mono mt-auto uppercase tracking-tighter" id="modal-id-display">ID: 01 // SEC_HEX</div>
            </div>
            <div class="w-full md:w-2/3 p-8 flex items-center justify-center bg-stone-900/30 relative overflow-hidden">
                <div id="modal-content" class="w-full modal-content-area space-y-4"></div>
            </div>
        </div>
    </div>

    <script>
        // --- URL DE GOOGLE APPS SCRIPT ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwBIRpuQp9cXRi9G3ALJhj2gbVQOy1Rs5Ioxyl7-ef4AA-VpLMECetlcKnl6BXt6ZrOIg/exec"; 

        // --- DATOS DE NIVELES (LIMPIOS) ---
        const RELATIONSHIP_DATA = [
            { 
                id: 1, 
                title: "El Encuentro", 
                storyFragment: `Fue en mi cumpleaños, el 21 de marzo de 2025. Tú asististe a esa actividad que me organizaron, y aunque tu decisión oficial era llevarme al metro, terminaste conduciendo hacia mi casa. Sin embargo, el destino tenía otros planes y nos detuvimos antes, en una esquina oscura bajo el manto de la noche.<br><br>Allí, la tensión sexual que habíamos estado cocinando a fuego lento durante todo el camino —alimentada por aquel contrato de sumisión que firmamos días atrás— finalmente detonó. No hubo palabras, solo acción. Nos empezamos a besar con urgencia, a tocarnos, a chuparnos... Los minutos se diluyeron en un caos de deseo absoluto donde nada más importaba.<br><br>Todo escaló peligrosamente rápido, una espiral de pasión que amenazaba con consumirnos ahí mismo, hasta que la realidad nos obligó a parar. Tuvimos que irnos, cada uno a su destino, pero marcados por la certeza de que algo irreversible había comenzado en esa esquina.`, 
                question: "Equinoccio de Primavera del año de la Singularidad (DDMMAAAA).", 
                answer: "21032025", 
                type: "chaospad", 
                game: "tictactoe_impossible", 
                timeLimit: 999999, 
                icon: "car-front" 
            },
            { id: 2, title: "DATA ENCRIPTADA", storyFragment: "...", question: "TBD", answer: "TBD", type: "TBD", game: "TBD", timeLimit: 1260, icon: "lock" },
            { id: 3, title: "DATA ENCRIPTADA", storyFragment: "...", question: "TBD", answer: "TBD", type: "TBD", game: "TBD", timeLimit: 1260, icon: "lock" },
            { id: 4, title: "DATA ENCRIPTADA", storyFragment: "...", question: "TBD", answer: "TBD", type: "TBD", game: "TBD", timeLimit: 1260, icon: "lock" },
            { id: 5, title: "DATA ENCRIPTADA", storyFragment: "...", question: "TBD", answer: "TBD", type: "TBD", game: "TBD", timeLimit: 1260, icon: "lock" },
            { id: 6, title: "DATA ENCRIPTADA", storyFragment: "...", question: "TBD", answer: "TBD", type: "TBD", game: "TBD", timeLimit: 1260, icon: "lock" },
            { id: 7, title: "DATA ENCRIPTADA", storyFragment: "...", question: "TBD", answer: "TBD", type: "TBD", game: "TBD", timeLimit: 1260, icon: "lock" },
            { id: 8, title: "DATA ENCRIPTADA", storyFragment: "...", question: "TBD", answer: "TBD", type: "TBD", game: "TBD", timeLimit: 1260, icon: "lock" },
            { id: 9, title: "DATA ENCRIPTADA", storyFragment: "...", question: "TBD", answer: "TBD", type: "TBD", game: "TBD", timeLimit: 1260, icon: "lock" },
            { id: 10, title: "DATA ENCRIPTADA", storyFragment: "...", question: "TBD", answer: "TBD", type: "TBD", game: "TBD", timeLimit: 1260, icon: "lock" }
        ];

        let userId = "", completedLevels = [], genesisTimestamp = null, activeLockouts = {}, tttAttempts = 0;
        let activeLevelData = null, timeLeft = 0, graceTime = 0, isGracePeriod = false, timerInterval = null, modalStage = "game", gameInternalState = {};

        // --- PROTECCIÓN ANTI-TRAMPAS ---
        document.addEventListener('keydown', function(e) {
            if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) || (e.ctrlKey && (e.keyCode === 85 || e.keyCode === 67))) {
                e.preventDefault();
                return false;
            }
        });

        window.onload = async () => {
            await initSession();
            checkAbandonment();
            runIntroSequence();
            renderGrid();
            setInterval(renderGrid, 60000); 
            lucide.createIcons();
        };

        async function initSession() {
            userId = localStorage.getItem('maria_user_id') || ('FEL-' + Math.random().toString(36).substr(2, 9).toUpperCase());
            localStorage.setItem('maria_user_id', userId);
            document.getElementById('display-user-id').innerText = userId;
            loadProgressLocal();
            if (GAS_URL) {
                try {
                    const resp = await fetch(`${GAS_URL}?userId=${userId}`);
                    const cloud = await resp.json();
                    if (cloud.status !== "not_found") {
                        if (cloud.completedLevels.length >= completedLevels.length) {
                            completedLevels = cloud.completedLevels;
                            genesisTimestamp = cloud.genesisTimestamp;
                            tttAttempts = cloud.tttAttempts;
                            saveToLocal();
                        }
                    }
                } catch (e) { console.warn("Cloud Sync Offline"); }
            }
        }

        function loadProgressLocal() {
            completedLevels = JSON.parse(localStorage.getItem('maria_completed') || '[]');
            activeLockouts = JSON.parse(localStorage.getItem('maria_lockouts') || '{}');
            tttAttempts = parseInt(localStorage.getItem('maria_ttt_attempts') || '0');
            const genesis = localStorage.getItem('maria_genesis_time');
            if (genesis) genesisTimestamp = parseInt(genesis);
        }

        function saveToLocal() {
            localStorage.setItem('maria_completed', JSON.stringify(completedLevels));
            localStorage.setItem('maria_ttt_attempts', tttAttempts.toString());
            if (genesisTimestamp) localStorage.setItem('maria_genesis_time', genesisTimestamp.toString());
            syncCloud();
        }

        async function syncCloud() {
            if (!GAS_URL) return;
            const payload = { userId, completedLevels, genesisTimestamp, tttAttempts };
            try { fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) }); } catch (e) {}
        }

        function restoreSessionPrompt() {
            const old = prompt("INGRESE ID_SESIÓN PARA RESTAURAR:");
            if (old && old.startsWith('FEL-')) {
                localStorage.setItem('maria_user_id', old.trim());
                location.reload();
            }
        }

        // --- INTRO ---
        async function runIntroSequence() {
            const out = document.getElementById('terminal-output');
            const loader = document.getElementById('loading-container');
            const lines = ["ENLACE: DIDAC-CLICK GROUP SECURE SERVER", "ESTABLECIENDO CONEXIÓN SEGURA...", "ACCEDIENDO AL NÚCLEO DE MEMORIA...", "INICIANDO PROTOCOLO: PROYECTO FELONÍA v1.0", "ESTADO: ESPERANDO USUARIO."];
            
            if (completedLevels.length > 0) { skipIntro(); return; }
            
            for (let line of lines) {
                const p = document.createElement('div');
                p.className = "mb-4 text-green-500 font-mono"; p.innerHTML = "> "; out.appendChild(p);
                for (let i = 0; i < line.length; i++) {
                    p.innerHTML = "> " + line.substring(0, i+1) + "<span class='cursor-blink'></span>";
                    await new Promise(r => setTimeout(r, 45));
                }
                p.innerHTML = "> " + line; await new Promise(r => setTimeout(r, 400));
            }
            
            loader.classList.remove('hidden');
            const bar = document.getElementById('intro-progress-bar'), pct = document.getElementById('intro-percentage');
            for (let i = 0; i <= 100; i++) {
                bar.style.width = i + "%"; pct.innerText = i + "%";
                await new Promise(r => setTimeout(r, 110)); 
            }
            endIntro();
        }

        function skipIntro() {
            document.getElementById('intro-screen').classList.add('hidden');
            document.getElementById('main-header').classList.replace('opacity-0', 'opacity-100');
            document.getElementById('level-grid').classList.replace('opacity-0', 'opacity-100');
        }

        function endIntro() {
            const scr = document.getElementById('intro-screen');
            scr.style.transition = "opacity 1.5s"; scr.style.opacity = "0";
            setTimeout(() => { scr.classList.add('hidden'); skipIntro(); }, 1500);
        }

        function checkAbandonment() {
            const act = localStorage.getItem('session_active_level');
            if (act && !completedLevels.includes(parseInt(act)) && parseInt(act) !== 1) {
                applyLockout(parseInt(act));
                document.getElementById('lockout-alert').classList.remove('hidden');
                setTimeout(() => alert("ABANDONO DETECTADO: BLOQUEO TEMPORAL ACTIVO."), 500);
            }
            localStorage.removeItem('session_active_level');
        }

        function applyLockout(id) {
            if (id === 1) return;
            activeLockouts[id] = new Date().getTime() + (3600000); 
            localStorage.setItem('maria_lockouts', JSON.stringify(activeLockouts));
            renderGrid();
        }

        function renderGrid() {
            const grid = document.getElementById('level-grid'); grid.innerHTML = '';
            const now = new Date().getTime();
            
            RELATIONSHIP_DATA.forEach(lvl => {
                const done = completedLevels.includes(lvl.id);
                let locked = lvl.id !== 1, timeText = "BLOQUEADO";
                
                if (activeLockouts[lvl.id] > now) {
                    locked = true; timeText = `BLOQUEO: ${Math.ceil((activeLockouts[lvl.id] - now)/60000)}m`;
                } else if (lvl.id !== 1 && completedLevels.includes(1)) {
                    const unlock = genesisTimestamp + ((lvl.id - 1) * 86400000);
                    if (now >= unlock) locked = false;
                    else {
                        const d = unlock - now;
                        timeText = `${Math.floor(d/3600000)}h ${Math.floor((d%3600000)/60000)}m`;
                    }
                } else if (lvl.id === 1) locked = false;

                const btn = document.createElement('button');
                const displayTitle = locked ? "SECTOR ENCRIPTADO" : lvl.title;
                const displayIcon = locked ? "lock" : lvl.icon;

                btn.className = `relative aspect-square rounded-2xl p-6 flex flex-col justify-between text-left group transition-all duration-500 overflow-hidden ${locked ? 'bg-stone-900/30 border border-stone-800 opacity-50 cursor-not-allowed' : (done ? 'bg-green-900/10 border border-green-800/30' : 'bg-gradient-to-br from-stone-900 to-stone-950 border border-green-700/50 shadow-lg scale-100 hover:scale-[1.02]')}`;
                
                if (!locked) btn.onclick = () => done ? alert("Registro recuperado de la memoria.") : openLevel(lvl);
                
                btn.innerHTML = `<div class="flex justify-between items-start z-10">
                    <span class="text-[10px] font-mono ${locked ? 'text-stone-600' : 'text-green-500'} font-bold">0${lvl.id}</span>
                    <i data-lucide="${done ? 'star' : (locked ? 'lock' : 'unlock')}" class="w-4 h-4 ${done ? 'text-green-500 fill-green-500' : (locked ? 'text-stone-700' : 'text-green-500 animate-pulse')}"></i>
                </div>
                <div class="absolute inset-0 flex items-center justify-center opacity-10 group-hover:opacity-20 transition-opacity pointer-events-none">
                    <i data-lucide="${displayIcon}" width="${lvl.id === 1 && !locked ? '80' : '64'}"></i>
                </div>
                <div class="z-10 mt-4">
                    <h3 class="text-sm font-light ${done ? 'text-green-700/50 line-through decoration-green-800/30' : 'text-green-100'}">${displayTitle}</h3>
                    <span class="text-[9px] uppercase tracking-widest text-green-600 font-bold">${locked ? timeText : (done ? 'Recuperado' : 'Sector Abierto')}</span>
                </div>`;
                grid.appendChild(btn);
            });
            lucide.createIcons();
        }

        function openLevel(data) {
            localStorage.setItem('session_active_level', data.id);
            activeLevelData = data; timeLeft = data.timeLimit; graceTime = 21; isGracePeriod = true; modalStage = "game";
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('modal-id-display').innerText = `ID: ${data.id} // SEC_KAIROS`;
            updateModalUI(); startLevelTimer();
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
            if (timerInterval) clearInterval(timerInterval);
            if (activeLevelData && completedLevels.includes(activeLevelData.id)) localStorage.removeItem('session_active_level');
            activeLevelData = null;
        }

        function startLevelTimer() {
            if (timerInterval) clearInterval(timerInterval);
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                if (isGracePeriod) {
                    if (--graceTime <= 0) {
                        isGracePeriod = false;
                        document.getElementById('timer-display').classList.add('animate-pulse');
                        setTimeout(() => document.getElementById('timer-display').classList.remove('animate-pulse'), 500);
                    }
                } else if (activeLevelData.id !== 1) {
                    if (--timeLeft <= 0) {
                        clearInterval(timerInterval); closeModal(); alert("TIEMPO AGOTADO.");
                        applyLockout(activeLevelData.id); localStorage.removeItem('session_active_level');
                    }
                }
                updateTimerDisplay();
            }, 1000);
        }

        function updateTimerDisplay() {
            const lbl = document.getElementById('timer-label'), disp = document.getElementById('timer-display'), bar = document.getElementById('time-bar');
            if (isGracePeriod) {
                lbl.innerText = "Lectura de Protocolo"; lbl.className = "text-[10px] text-stone-400 font-mono mb-3";
                disp.innerText = graceTime + "s"; bar.style.width = "100%"; bar.className = "h-full bg-stone-700 transition-all";
            } else {
                lbl.innerText = activeLevelData.id === 1 ? "Tiempo Ilimitado" : "Tiempo Restante"; lbl.className = "text-[10px] text-green-600 font-mono mb-3";
                disp.innerText = activeLevelData.id === 1 ? "∞" : `${Math.floor(timeLeft/60)}:${(timeLeft%60).toString().padStart(2,'0')}`;
                bar.style.width = activeLevelData.id === 1 ? "100%" : (timeLeft/activeLevelData.timeLimit)*100 + "%";
                bar.className = "h-full bg-green-600 transition-all shadow-[0_0_10px_rgba(22,163,74,0.3)]";
            }
        }

        function updateModalUI() {
            const title = document.getElementById('modal-title'), desc = document.getElementById('modal-desc'), content = document.getElementById('modal-content');
            content.innerHTML = '';
            if (modalStage === "game") {
                title.innerText = "Sistema de Defensa";
                desc.innerHTML = `GUARDIÁN: <strong class="text-green-400">KAIROS</strong><br><br><span class="text-stone-300 font-bold uppercase tracking-tighter">Reglas:</span><br>1. Victoria absoluta (Un empate reinicia el ciclo).<br>2. KAIROS presenta fluctuaciones críticas en su matriz. Vigilancia máxima.<br>3. Intentos ilimitados habilitados para este sector.`;
                renderTTT(content);
            } else {
                title.innerText = "Clave Requerida"; desc.innerText = activeLevelData.question;
                renderPad(content);
            }
            lucide.createIcons();
        }

        function renderTTT(container) {
            tttAttempts++; localStorage.setItem('maria_ttt_attempts', tttAttempts); syncCloud();
            gameInternalState.board = Array(9).fill(null); gameInternalState.turn = Math.random() > 0.5; gameInternalState.active = true;
            let html = '<div class="grid grid-cols-3 gap-3 mb-6">';
            for(let i=0; i<9; i++) html += `<button onclick="handleTTT(${i})" id="ttt-${i}" class="w-20 h-20 rounded-xl bg-stone-800/50 border border-stone-700 text-3xl font-bold text-stone-500 transition-all hover:bg-stone-800 active:scale-95"></button>`;
            html += `</div><div class="flex justify-between w-full px-4 text-[10px] font-mono text-stone-500 uppercase tracking-widest font-bold"><span>Ciclo: #${tttAttempts}</span><span id="ttt-status">Inicia: ${gameInternalState.turn ? 'María' : 'KAIROS'}</span></div>`;
            container.innerHTML = html;
            if (!gameInternalState.turn) setTimeout(aiMove, 600);
        }

        function handleTTT(idx) {
            if (!gameInternalState.active || gameInternalState.board[idx] || !gameInternalState.turn) return;
            gameInternalState.board[idx] = 'X'; updateBoard();
            if (checkWin('X')) return finishTTT('V');
            if (!gameInternalState.board.includes(null)) return finishTTT('E');
            gameInternalState.turn = false; document.getElementById('ttt-status').innerText = "KAIROS Pensando...";
            setTimeout(aiMove, 600);
        }

        function aiMove() {
            if (!gameInternalState.active) return;
            const spots = gameInternalState.board.map((v,i) => v===null?i:null).filter(v=>v!==null);
            let move;
            if (tttAttempts % 21 === 0 && spots.length > 1) move = spots[Math.floor(Math.random()*spots.length)];
            else move = minimax(gameInternalState.board, 'O').index;
            
            gameInternalState.board[move] = 'O'; updateBoard();
            if (checkWin('O')) return finishTTT('F');
            if (!gameInternalState.board.includes(null)) return finishTTT('E');
            gameInternalState.turn = true; document.getElementById('ttt-status').innerText = "Tu Turno";
        }

        function finishTTT(type) {
            gameInternalState.active = false;
            if (type === 'V') { modalStage = "question"; setTimeout(updateModalUI, 800); }
            else if (type === 'F') { alert("Fallo: KAIROS ha vencido."); setTimeout(() => renderTTT(document.getElementById('modal-content')), 800); }
            else { alert("Empate: Exijo perfección."); setTimeout(() => renderTTT(document.getElementById('modal-content')), 800); }
        }

        function updateBoard() {
            gameInternalState.board.forEach((v,i) => {
                const b = document.getElementById(`ttt-${i}`); if(!b) return;
                b.innerText = v || '';
                if(v === 'X') b.className = "w-20 h-20 rounded-xl bg-green-900/20 border border-green-600 text-3xl font-bold text-green-400";
                if(v === 'O') b.className = "w-20 h-20 rounded-xl bg-stone-800 border border-stone-600 text-3xl font-bold text-white shadow-inner";
            });
        }

        function checkWin(p) {
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            return wins.some(l => l.every(i => gameInternalState.board[i] === p));
        }

        function minimax(board, p) {
            const avail = board.map((v,i) => v===null?i:null).filter(v=>v!==null);
            if (checkWin('X')) return {score:-10};
            if (checkWin('O')) return {score:10};
            if (avail.length === 0) return {score:0};
            const moves = [];
            for (let i=0; i<avail.length; i++) {
                const m = {index: avail[i]};
                board[avail[i]] = p;
                m.score = minimax(board, p==='O'?'X':'O').score;
                board[avail[i]] = null;
                moves.push(m);
            }
            return moves.reduce((a, b) => (p==='O' ? (b.score > a.score) : (b.score < a.score)) ? b : a);
        }

        function renderPad(container) {
            gameInternalState.input = "";
            container.innerHTML = `<div id="pad-disp" class="w-64 bg-black p-5 mb-4 text-center font-mono text-2xl border border-green-900/40 rounded-xl text-green-100 shadow-inner tracking-widest font-bold">DDMMAAAA</div><div id="pad-grid" class="grid grid-cols-3 gap-3 w-64"></div><div class="flex gap-2 w-64 mt-4"><button onclick="updPad('C')" class="flex-1 p-3 bg-red-900/10 text-red-500 border border-red-900/20 rounded-lg text-xs font-bold uppercase tracking-tighter">Borrar</button><button onclick="checkAns()" class="flex-1 p-3 bg-green-800 text-white rounded-lg text-xs font-bold shadow-lg uppercase tracking-widest hover:bg-green-700 transition-colors">Confirmar</button></div>`;
            renderButtons();
        }

        function renderButtons() {
            const nums = [1,2,3,4,5,6,7,8,9,0].sort(() => Math.random()-0.5);
            const grid = document.getElementById('pad-grid');
            if (grid) grid.innerHTML = nums.map(n => `<button onclick="updPad(${n})" class="p-4 bg-stone-800 border border-stone-700 rounded-xl hover:bg-stone-700 transition-all active:scale-90 font-mono text-white">${n}</button>`).join('');
        }

        function updPad(v) {
            if (v==='C') gameInternalState.input = "";
            else if (gameInternalState.input.length < 8) gameInternalState.input += v;
            document.getElementById('pad-disp').innerText = gameInternalState.input || "DDMMAAAA";
            if(v!=='C') renderButtons();
        }

        function checkAns() {
            if (gameInternalState.input === activeLevelData.answer) {
                if (activeLevelData.id === 1 && !completedLevels.includes(1)) {
                    completedLevels.push(1); genesisTimestamp = new Date().getTime();
                } else if (!completedLevels.includes(activeLevelData.id)) completedLevels.push(activeLevelData.id);
                saveToLocal(); closeModal(); renderGrid();
                setTimeout(() => { alert("ACCESO CONCEDIDO: SECTOR RECUPERADO."); showStory(); }, 500);
            } else { alert("ERROR DE CLAVE: ACCESO DENEGADO."); updPad('C'); }
        }

        function showStory() {
            document.getElementById('story-screen').classList.remove('hidden');
            const container = document.getElementById('story-content'); container.innerHTML = "";
            const visible = RELATIONSHIP_DATA.filter(l => completedLevels.includes(l.id));
            if (!visible.length) { container.innerHTML = "<p class='text-center text-stone-500'>No hay fragmentos recuperados aún.</p>"; return; }
            let fullHtml = "";
            visible.forEach(l => {
                fullHtml += `<div class="mb-12 border-l-2 border-green-800 pl-6 pb-2"><span class="text-[10px] text-green-600 font-mono block mb-2 font-bold tracking-widest uppercase">LOG_0${l.id} // SECTOR RECUPERADO</span><div class="text-stone-300 leading-relaxed">${l.storyFragment}</div></div>`;
            });
            let i = 0;
            function type() {
                if (i < fullHtml.length) {
                    let char = fullHtml.charAt(i), toAdd = char;
                    if (char === '<') {
                        let tag = ""; while (fullHtml.charAt(i) !== '>') tag += fullHtml.charAt(i++);
                        tag += '>'; toAdd = tag;
                    }
                    container.innerHTML += toAdd; i++;
                    setTimeout(type, toAdd.length > 1 ? 0 : 25);
                }
            }
            type();
        }

        function closeStory() { document.getElementById('story-screen').classList.add('hidden'); }
    </script>
</body>
</html>
